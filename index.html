<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist de An√°lise de FIIs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase App (o core do Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --muted: #9aa7b2;
            --accent: #60a5fa;
            --glass: rgba(255,255,255,0.03);
            --success: #10b981;
            --danger: #ef4444;
            --card-border: rgba(255,255,255,0.04);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: var(--bg);
            color: white;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass);
        }
        
        h1 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .app-description {
            color: var(--muted);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background: var(--glass);
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            border: 1px solid var(--card-border);
            border-bottom: none;
            color: var(--muted);
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: var(--card);
            font-weight: bold;
            color: var(--accent);
        }
        
        .tab:hover {
            background: rgba(96, 165, 250, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .fund-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--glass);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }
        
        .fund-info input, .fund-info select {
            padding: 12px;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .fund-info input::placeholder {
            color: var(--muted);
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 12px;
            background-color: var(--glass);
            border: 1px solid var(--card-border);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .section-title h2 {
            margin-left: 10px;
            font-size: 1.5rem;
        }
        
        .checklist-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        
        .checklist-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
            margin-bottom: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--card-border);
        }
        
        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            margin-right: 8px;
        }
        
        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-top: 5px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            resize: vertical;
        }
        
        textarea {
            min-height: 80px;
        }
        
        textarea::placeholder {
            color: var(--muted);
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-save {
            background-color: var(--success);
            color: white;
        }
        
        .btn-save:hover {
            background-color: #0da271;
        }
        
        .btn-reset {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-reset:hover {
            background-color: #dc2626;
        }
        
        .btn-print {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-print:hover {
            background-color: #3b82f6;
        }
        
        .search-box {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .search-box input::placeholder {
            color: var(--muted);
        }
        
        .search-box button {
            padding: 12px 20px;
        }
        
        .reports-list {
            margin-top: 20px;
        }
        
        .report-item {
            padding: 15px;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-info {
            flex: 1;
        }
        
        .report-info h3 {
            color: var(--accent);
            margin-bottom: 5px;
        }
        
        .report-info p {
            color: var(--muted);
            font-size: 0.9rem;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
        }
        
        .report-btn {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .auth-section {
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--glass);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            text-align: center;
        }
        
        .auth-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .user-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 8px;
        }
        
        .firebase-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .status-disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        @media (max-width: 768px) {
            .fund-info {
                flex-direction: column;
            }
            
            .fund-info input, .fund-info select {
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .report-item {
                flex-direction: column;
                gap: 10px;
            }
            
            .report-actions {
                width: 100%;
                justify-content: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
                border-radius: 8px;
                border: 1px solid var(--card-border);
            }
            
            .auth-buttons {
                flex-direction: column;
            }
        }
        
        .observations {
            margin-top: 15px;
        }
        
        .observations textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
        }
        
        .checkbox-item {
            transition: all 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: rgba(96, 165, 250, 0.1);
        }
        
        .checkbox-item input[type="checkbox"]:checked,
        .checkbox-item input[type="radio"]:checked {
            accent-color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Checklist de An√°lise de FIIs</h1>
            <p class="app-description">An√°lise completa de fundos imobili√°rios com sistema de salvamento em nuvem</p>
        </header>
        
        <!-- Se√ß√£o de Autentica√ß√£o Firebase -->
        <div class="auth-section" id="auth-section">
            <h3><i class="fas fa-user"></i> Autentica√ß√£o Firebase</h3>
            <p>Fa√ßa login para salvar suas an√°lises na nuvem</p>
            <div class="firebase-status" id="firebase-status">Verificando conex√£o...</div>
            <div id="user-info" class="user-info" style="display: none;">
                <p>Logado como: <span id="user-email"></span></p>
            </div>
            <div class="auth-buttons">
                <button id="login-btn" class="btn-save">
                    <i class="fas fa-sign-in-alt"></i> Fazer Login
                </button>
                <button id="logout-btn" class="btn-reset" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="form">Nova An√°lise</div>
            <div class="tab" data-tab="reports">Relat√≥rios Salvos</div>
            <div class="tab" data-tab="help">Ajuda</div>
        </div>
        
        <div class="tab-content active" id="form-tab">
            <div class="fund-info">
                <input type="text" id="fund-name" placeholder="Nome do Fundo">
                <input type="text" id="analysis-date" placeholder="M√™s/Ano de Refer√™ncia (MM/AAAA)">
                <input type="text" id="analyst-name" placeholder="Nome do Analista">
            </div>
            
            <form id="checklist-form">
                <!-- ESTRUTURA DO FUNDO -->
                <div class="section">
                    <div class="section-title">
                        <span>üè¶</span>
                        <h2>Estrutura do Fundo</h2>
                    </div>
                    
                    <div class="checklist-item">
                        <label>Qual a estrat√©gia/objetivo do fundo? (renda, ganho de capital, reciclagem de portf√≥lio, etc.)</label>
                        <textarea id="strategy" placeholder="Descreva a estrat√©gia do fundo..."></textarea>
                    </div>
                    
                    <!-- ... (mantenha todo o conte√∫do do formul√°rio igual) ... -->
                    
                </div>
                
                <!-- ... (mantenha todas as se√ß√µes do formul√°rio) ... -->
                
                <div class="btn-group">
                    <button type="button" class="btn-save" id="save-btn">
                        <i class="fas fa-save"></i> Salvar An√°lise
                    </button>
                    <button type="reset" class="btn-reset">
                        <i class="fas fa-trash"></i> Limpar Formul√°rio
                    </button>
                    <button type="button" class="btn-print" id="print-btn">
                        <i class="fas fa-print"></i> Imprimir/Exportar
                    </button>
                </div>
            </form>
        </div>
        
        <div class="tab-content" id="reports-tab">
            <h2><i class="fas fa-file-alt"></i> Relat√≥rios Salvos</h2>
            <p>Encontre e gerencie suas an√°lises salvas</p>
            
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Pesquisar por nome do fundo ou data...">
                <button class="btn-save" id="search-btn">
                    <i class="fas fa-search"></i> Pesquisar
                </button>
            </div>
            
            <div id="reports-list">
                <!-- Os relat√≥rios ser√£o carregados aqui via JavaScript -->
                <p class="loading-text">Carregando relat√≥rios...</p>
            </div>
        </div>
        
        <div class="tab-content" id="help-tab">
            <h2><i class="fas fa-question-circle"></i> Ajuda e Informa√ß√µes</h2>
            
            <div class="section">
                <h3>Onde os relat√≥rios s√£o salvos?</h3>
                <p>Todos os relat√≥rios s√£o salvos na nuvem usando <strong>Firebase Firestore</strong>.</p>
                <p>Isso significa que voc√™ pode acessar suas an√°lises de qualquer dispositivo ap√≥s fazer login.</p>
            </div>
            
            <div class="section">
                <h3>Como pesquisar relat√≥rios?</h3>
                <p>Na aba "Relat√≥rios Salvos", digite o nome do fundo ou a data no campo de pesquisa e clique no bot√£o "Pesquisar".</p>
            </div>
            
            <div class="section">
                <h3>Os dados ser√£o perdidos se eu limpar o navegador?</h3>
                <p>N√£o, pois os dados s√£o armazenados na nuvem. Se voc√™ limpar o hist√≥rico e dados de navega√ß√£o, basta fazer login novamente para recuperar suas an√°lises.</p>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configura√ß√£o do Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDCplzRR5imGdGCpr6PnKEwo2rs5qPrV6c",
                authDomain: "rianalise.firebaseapp.com",
                projectId: "rianalise",
                storageBucket: "rianalise.firebasestorage.app",
                messagingSenderId: "46433102386",
                appId: "1:46433102386:web:918bfbc2f0834604daaa2b",
                measurementId: "G-ZQ2178VY8N"
            };

            // Inicializar Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                const auth = firebase.auth();
                
                // Atualizar status
                document.getElementById('firebase-status').textContent = "Firebase inicializado com sucesso";
                document.getElementById('firebase-status').className = "firebase-status status-connected";
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                document.getElementById('firebase-status').textContent = "Erro ao inicializar Firebase: " + error.message;
                document.getElementById('firebase-status').className = "firebase-status status-disconnected";
            }
            
            // Elementos da interface
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const saveBtn = document.getElementById('save-btn');
            const printBtn = document.getElementById('print-btn');
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            const reportsList = document.getElementById('reports-list');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            // Estado da aplica√ß√£o
            let currentUser = null;
            let isFirebaseConnected = false;
            
            // Verificar se o Firebase foi inicializado corretamente
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                isFirebaseConnected = true;
                
                // Monitorar estado de autentica√ß√£o
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        userEmail.textContent = user.email;
                        userInfo.style.display = 'block';
                        loginBtn.style.display = 'none';
                        logoutBtn.style.display = 'block';
                        console.log("Usu√°rio logado:", user.email);
                        
                        // Carregar relat√≥rios quando o usu√°rio fizer login
                        if (document.querySelector('.tab.active').getAttribute('data-tab') === 'reports') {
                            loadReportsFromFirebase();
                        }
                    } else {
                        currentUser = null;
                        userInfo.style.display = 'none';
                        loginBtn.style.display = 'block';
                        logoutBtn.style.display = 'none';
                        console.log("Usu√°rio n√£o logado");
                    }
                });
            } else {
                firebaseStatus.textContent = "Firebase n√£o inicializado. Verifique a configura√ß√£o.";
                firebaseStatus.className = "firebase-status status-disconnected";
            }
            
            // Mostrar notifica√ß√£o
            function showNotification(message, isError = false) {
                notificationText.textContent = message;
                notification.className = isError ? 'notification error' : 'notification';
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // Login com Google
            loginBtn.addEventListener('click', () => {
                if (typeof firebase === 'undefined') {
                    showNotification("Firebase n√£o carregado. Verifique sua conex√£o com a internet.", true);
                    return;
                }
                
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider)
                    .then((result) => {
                        console.log("Login bem-sucedido:", result.user);
                        showNotification("Login realizado com sucesso!");
                    })
                    .catch((error) => {
                        console.error("Erro no login:", error);
                        if (error.code === 'auth/unauthorized-domain') {
                            showNotification("Erro: Dom√≠nio n√£o autorizado. Configure seu dom√≠nio no Console do Firebase.", true);
                        } else {
                            showNotification("Erro ao fazer login: " + error.message, true);
                        }
                    });
            });
            
            // Logout
            logoutBtn.addEventListener('click', () => {
                if (typeof firebase !== 'undefined') {
                    firebase.auth().signOut()
                        .then(() => {
                            console.log("Logout bem-sucedido");
                            showNotification("Logout realizado com sucesso!");
                        })
                        .catch((error) => {
                            console.error("Erro no logout:", error);
                            showNotification("Erro ao fazer logout: " + error.message, true);
                        });
                }
            });
            
            // Sistema de abas
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Ativar aba clicada
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Mostrar conte√∫do correspondente
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Se for a aba de relat√≥rios, carregar os relat√≥rios
                    if (tabId === 'reports') {
                        loadReportsFromFirebase();
                    }
                });
            });
            
            // Preencher automaticamente a data atual no campo de data
            const today = new Date();
            const month = today.getMonth() + 1;
            const year = today.getFullYear();
            document.getElementById('analysis-date').value = `${month.toString().padStart(2, '0')}/${year}`;
            
            // Salvar dados no Firebase
            saveBtn.addEventListener('click', function() {
                const fundName = document.getElementById('fund-name').value;
                if (!fundName) {
                    showNotification('Por favor, informe o nome do fundo antes de salvar.', true);
                    return;
                }
                
                if (!currentUser) {
                    showNotification('Fa√ßa login para salvar an√°lises.', true);
                    return;
                }
                
                // Coletar todos os dados do formul√°rio
                const formData = {
                    fundName: fundName,
                    analysisDate: document.getElementById('analysis-date').value,
                    analystName: document.getElementById('analyst-name').value,
                    strategy: document.getElementById('strategy').value,
                    segments: getSelectedCheckboxes('segment'),
                    otherSegment: document.getElementById('other-segment-text').value,
                    managementType: getSelectedRadio('management-type'),
                    ifixComparison: getSelectedRadio('ifix-comparison'),
                    propertyCount: document.getElementById('property-count').value,
                    allocationProperties: document.getElementById('allocation-properties').value,
                    allocationFiis: document.getElementById('allocation-fiis').value,
                    allocationCash: document.getElementById('allocation-cash').value,
                    typicalContracts: document.getElementById('typical-contracts').value,
                    atypicalContracts: document.getElementById('atypical-contracts').value,
                    averageContractTerm: document.getElementById('average-contract-term').value,
                    expiringContracts: document.getElementById('expiring-contracts').value,
                    activeTenants: document.getElementById('active-tenants').value,
                    tenantSegments: document.getElementById('tenant-segments').value,
                    largestSector: document.getElementById('largest-sector').value,
                    tenantConcentration: document.getElementById('tenant-concentration').value,
                    tenantFinancials: document.getElementById('tenant-financials').value,
                    gracePeriod: getSelectedRadio('grace-period'),
                    // Novos campos de Governan√ßa
                    managerHistory: document.getElementById('manager-history').value,
                    managerChange: getSelectedRadio('manager-change'),
                    managerChangeDetails: document.getElementById('manager-change-details').value,
                    conflicts: getSelectedRadio('conflicts'),
                    conflictsDetails: document.getElementById('conflicts-details').value,
                    transparency: getSelectedRadio('transparency'),
                    // Novos campos de Desempenho
                    vpcEvolution: document.getElementById('vpc-evolution').value,
                    currentVsAvg: document.getElementById('current-vs-avg').value,
                    yieldComparison: document.getElementById('yield-comparison').value,
                    sectorComparison: document.getElementById('sector-comparison').value,
                    fundClassification: getSelectedCheckboxes('fund-classification'),
                    // Campos existentes
                    financialVacancy: document.getElementById('financial-vacancy').value,
                    physicalVacancy: document.getElementById('physical-vacancy').value,
                    defaultRate: document.getElementById('default-rate').value,
                    resultComparison: getSelectedRadio('result-comparison'),
                    resultReason: document.getElementById('result-reason').value,
                    leverage: getSelectedRadio('leverage'),
                    leverageRate: document.getElementById('leverage-rate').value,
                    amortizationPlan: document.getElementById('amortization-plan').value,
                    liquidity: getSelectedRadio('liquidity'),
                    importantNotices: document.getElementById('important-notices').value,
                    riskLevel: getSelectedRadio('risk-level'),
                    mainRisks: document.getElementById('main-risks').value,
                    opportunities: document.getElementById('opportunities').value,
                    anchor: getSelectedRadio('anchor'),
                    positivePoints: document.getElementById('positive-points').value,
                    negativePoints: document.getElementById('negative-points').value,
                    cashBurn: document.getElementById('cash-burn').value,
                    balanceSustainability: document.getElementById('balance-sustainability').value,
                    discount: document.getElementById('discount').value,
                    expectation: getSelectedRadio('expectation'),
                    recommendation: getSelectedRadio('recommendation'),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Salvar no Firebase
                firebase.firestore().collection('analises').add(formData)
                    .then((docRef) => {
                        console.log("An√°lise salva no Firebase com ID: ", docRef.id);
                        showNotification(`An√°lise de ${fundName} salva com sucesso na nuvem!`);
                        document.getElementById('checklist-form').reset();
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar no Firebase: ", error);
                        showNotification("Erro ao salvar an√°lise: " + error.message, true);
                    });
            });
            
            // Carregar relat√≥rios do Firebase
            function loadReportsFromFirebase(searchTerm = '') {
                if (!currentUser) {
                    reportsList.innerHTML = '<p>Fa√ßa login para ver seus relat√≥rios salvos.</p>';
                    return;
                }
                
                reportsList.innerHTML = '<p class="loading-text">Carregando relat√≥rios...</p>';
                
                let query = firebase.firestore().collection('analises')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc');
                
                query.get()
                    .then((querySnapshot) => {
                        reportsList.innerHTML = '';
                        
                        if (querySnapshot.empty) {
                            reportsList.innerHTML = '<p>Nenhum relat√≥rio encontrado.</p>';
                            return;
                        }
                        
                        querySnapshot.forEach((doc) => {
                            const report = doc.data();
                            const reportId = doc.id;
                            
                            // Verificar se corresponde ao termo de pesquisa
                            if (!searchTerm || 
                                report.fundName.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                report.analysisDate.toLowerCase().includes(searchTerm.toLowerCase())) {
                                
                                const reportElement = document.createElement('div');
                                reportElement.className = 'report-item';
                                reportElement.innerHTML = `
                                    <div class="report-info">
                                        <h3>${report.fundName}</h3>
                                        <p>Data: ${report.analysisDate} | Analista: ${report.analystName || 'N√£o informado'}</p>
                                        <p>Salvo em: ${new Date(report.timestamp?.toDate()).toLocaleString()}</p>
                                    </div>
                                    <div class="report-actions">
                                        <button class="btn-save report-btn view-btn" data-id="${reportId}">
                                            <i class="fas fa-eye"></i> Ver
                                        </button>
                                        <button class="btn-print report-btn load-btn" data-id="${reportId}">
                                            <i class="fas fa-upload"></i> Carregar
                                        </button>
                                        <button class="btn-reset report-btn delete-btn" data-id="${reportId}">
                                            <i class="fas fa-trash"></i> Excluir
                                        </button>
                                    </div>
                                `;
                                
                                reportsList.appendChild(reportElement);
                            }
                        });
                        
                        if (reportsList.children.length === 0) {
                            reportsList.innerHTML = '<p>Nenhum relat√≥rio corresponde √† pesquisa.</p>';
                        }
                        
                        // Adicionar event listeners aos bot√µes
                        document.querySelectorAll('.view-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                viewReport(id);
                            });
                        });
                        
                        document.querySelectorAll('.load-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                loadReport(id);
                            });
                        });
                        
                        document.querySelectorAll('.delete-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                deleteReport(id);
                            });
                        });
                    })
                    .catch((error) => {
                        console.error("Erro ao carregar relat√≥rios: ", error);
                        reportsList.innerHTML = '<p>Erro ao carregar relat√≥rios.</p>';
                    });
            }
            
            // Pesquisar relat√≥rios
            searchBtn.addEventListener('click', function() {
                loadReportsFromFirebase(searchInput.value);
            });
            
            // Fun√ß√£o para visualizar relat√≥rio
            function viewReport(id) {
                firebase.firestore().collection('analises').doc(id).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const report = doc.data();
                            let content = `
                                <h2>Relat√≥rio: ${report.fundName}</h2>
                                <p><strong>Data:</strong> ${report.analysisDate}</p>
                                <p><strong>Analista:</strong> ${report.analystName || 'N√£o informado'}</p>
                                <p><strong>Salvo em:</strong> ${new Date(report.timestamp?.toDate()).toLocaleString()}</p>
                                <hr>
                                <h3>Estrat√©gia/Objetivo:</h3>
                                <p>${report.strategy || 'N√£o informado'}</p>
                                <h3>Pontos Positivos:</h3>
                                <p>${report.positivePoints || 'N√£o informado'}</p>
                                <h3>Pontos Negativos:</h3>
                                <p>${report.negativePoints || 'N√£o informado'}</p>
                            `;
                            
                            // Usando alert nativo por simplicidade
                            alert(content);
                        } else {
                            showNotification("Relat√≥rio n√£o encontrado.", true);
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao buscar relat√≥rio: ", error);
                        showNotification("Erro ao carregar relat√≥rio: " + error.message, true);
                    });
            }
            
            // Fun√ß√£o para carregar relat√≥rio no formul√°rio
            function loadReport(id) {
                firebase.firestore().collection('analises').doc(id).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const report = doc.data();
                            
                            // Preencher campos do formul√°rio
                            document.getElementById('fund-name').value = report.fundName || '';
                            document.getElementById('analysis-date').value = report.analysisDate || '';
                            document.getElementById('analyst-name').value = report.analystName || '';
                            document.getElementById('strategy').value = report.strategy || '';
                            // ... (preencher todos os outros campos)
                            
                            // Mudar para a aba do formul√°rio
                            tabs.forEach(t => t.classList.remove('active'));
                            tabContents.forEach(c => c.classList.remove('active'));
                            document.querySelector('.tab[data-tab="form"]').classList.add('active');
                            document.getElementById('form-tab').classList.add('active');
                            
                            showNotification(`Relat√≥rio de ${report.fundName} carregado com sucesso!`);
                        } else {
                            showNotification("Relat√≥rio n√£o encontrado.", true);
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao carregar relat√≥rio: ", error);
                        showNotification("Erro ao carregar relat√≥rio: " + error.message, true);
                    });
            }
            
            // Fun√ß√£o para excluir relat√≥rio
            function deleteReport(id) {
                if (confirm('Tem certeza que deseja excluir este relat√≥rio?')) {
                    firebase.firestore().collection('analises').doc(id).delete()
                        .then(() => {
                            showNotification('Relat√≥rio exclu√≠do com sucesso.');
                            loadReportsFromFirebase(); // Recarregar a lista
                        })
                        .catch((error) => {
                            console.error("Erro ao excluir relat√≥rio: ", error);
                            showNotification("Erro ao excluir relat√≥rio: " + error.message, true);
                        });
                }
            }
            
            // Fun√ß√µes auxiliares para obter valores de checkboxes e radios
            function getSelectedCheckboxes(name) {
                const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
                return Array.from(checkboxes).map(cb => cb.nextElementSibling.textContent);
            }
            
            function getSelectedRadio(name) {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                return radio ? radio.value : null;
            }
            
            // Imprimir/exportar formul√°rio
            printBtn.addEventListener('click', function() {
                window.print();
            });
        });
    </script>
</body>
</html>