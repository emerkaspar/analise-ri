<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fundoscópio</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <link
      rel="icon"
      type="image/png"
      href="https://raw.githubusercontent.com/emerkaspar/analise-ri/refs/heads/main/favicon.png"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --bg: #0f1724;
        --card: #0b1220;
        --muted: #9aa7b2;
        --accent: #19c4b6;
        --glass: rgba(255, 255, 255, 0.03);
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --card-border: rgba(255, 255, 255, 0.04);
        font-family: "Lato", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--bg);
        color: white;
        line-height: 1.6;
        padding: 10px;
        min-height: 100vh;
        font-family: "Lato", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      
      h1, h2, h3, h4, h5, h6, button, input, textarea, select {
        font-family: "Lato", sans-serif;
      }


      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--card);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--card-border);
        position: relative;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--glass);
        flex-wrap: wrap;
        gap: 20px;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-shrink: 0;
      }

      .logo {
        max-width: 120px;
        height: auto;
      }

      .logo img {
        width: 100%;
        height: auto;
        border-radius: 8px;
      }

      .titles {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      h1 {
        color: var(--accent);
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1.2;
        margin: 0;
      }

      .app-description {
        color: var(--muted);
        font-size: 0.95rem;
        font-weight: 400;
        margin-top: 4px;
      }

      /* --- ESTILOS PARA A ÁREA DE LOGIN --- */
      .auth-section {
          position: relative;
          min-width: auto;
      }
      
      #login-btn {
          background-color: var(--accent);
          color: white;
      }
      #login-btn:hover {
          background-color: #15a89c;
          transform: translateY(-2px);
          box-shadow: 0 4px 10px rgba(25, 196, 182, 0.2);
      }
      
      .user-profile-button {
          display: flex;
          align-items: center;
          gap: 10px;
          background: var(--glass);
          border: 1px solid var(--card-border);
          border-radius: 50px;
          padding: 5px 15px 5px 5px;
          cursor: pointer;
          transition: background-color 0.3s ease;
          color: white; 
      }
      
      .user-profile-button:hover {
          background-color: rgba(255, 255, 255, 0.07);
      }
      
      .user-profile-button img {
          width: 32px;
          height: 32px;
          border-radius: 50%;
      }
      
      .user-profile-button span {
          font-weight: 600;
          color: white;
      }
      
      .user-dropdown {
          position: absolute;
          top: 110%;
          right: 0;
          background: #1a2433;
          border-radius: 8px;
          box-shadow: 0 8px 16px rgba(0,0,0,0.3);
          width: 250px;
          z-index: 100;
          overflow: hidden;
          transition: opacity 0.2s ease, transform 0.2s ease;
          transform: translateY(10px);
          opacity: 0;
          pointer-events: none;
      }
      
      .user-dropdown.active {
          transform: translateY(0);
          opacity: 1;
          pointer-events: auto;
      }
      
      .dropdown-user-info {
          padding: 15px;
          background: var(--accent);
          color: #fff;
      }
      
      .dropdown-user-info h4 {
          margin: 0;
          font-size: 1rem;
          font-weight: 700;
      }
      
      .dropdown-user-info p {
          margin: 0;
          font-size: 0.8rem;
          opacity: 0.9;
      }
      
      .dropdown-actions {
          list-style: none;
          padding: 8px 0;
      }
      
      .dropdown-actions li button {
          background: none;
          border: none;
          color: var(--muted);
          width: 100%;
          text-align: left;
          padding: 10px 15px;
          font-size: 0.9rem;
          cursor: pointer;
          justify-content: flex-start;
      }
      
      .dropdown-actions li button:hover {
          background-color: var(--glass);
          color: white;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--glass);
        flex-wrap: wrap;
      }

      .tab {
        padding: 12px 20px;
        cursor: pointer;
        background: var(--glass);
        border-radius: 8px 8px 0 0;
        margin-right: 5px;
        border: 1px solid var(--card-border);
        border-bottom: none;
        color: var(--muted);
        transition: all 0.3s ease;
      }

      .tab.active {
        background: var(--card);
        font-weight: bold;
        color: var(--accent);
      }

      .tab:hover {
        background: rgba(96, 165, 250, 0.1);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* --- ESTILOS PARA BLOCOS DE ESCOLHA --- */
      #analysis-choice-container {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 50px 0;
        flex-wrap: wrap;
      }

      .choice-card {
        background: var(--glass);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 25px;
        width: 300px;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid var(--accent);
      }

      .choice-card:hover {
        transform: translateY(-5px);
        border-color: var(--accent);
        box-shadow: 0 10px 25px rgba(25, 196, 182, 0.1);
      }

      .choice-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        color: var(--accent);
      }

      .choice-card h3 {
        color: white;
        font-size: 1.25rem;
        margin-bottom: 10px;
      }

      .choice-card p {
        color: var(--muted);
        font-size: 0.9rem;
      }
      
      .btn-switch-analysis {
        background: linear-gradient(90deg, #6366f1, #a855f7);
        color: white;
        margin-bottom: 20px;
      }

      .fund-info {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background-color: var(--glass);
        border-radius: 12px;
        border: 1px solid var(--card-border);
      }

      .fund-info input,
      .fund-info select {
        padding: 12px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        flex: 1;
        min-width: 200px;
        background: rgba(0, 0, 0, 0.2);
        color: white;
      }

      .fund-info input::placeholder {
        color: var(--muted);
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 12px;
        background-color: var(--glass);
        border: 1px solid var(--card-border);
      }
       
      .section h3 {
        color: var(--accent);
        margin-bottom: 10px;
      }

      .section p {
        margin-bottom: 15px;
      }
       
      .section ul {
        list-style-position: inside;
        padding-left: 10px;
      }

      .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        color: var(--accent);
      }

      .section-title h2 {
        margin-left: 10px;
        font-size: 1.5rem;
      }

      .checklist-item {
        margin-bottom: 15px;
        padding: 15px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        border-left: 3px solid var(--accent);
      }

      .checklist-item label {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-weight: 700;
        color: white;
      }
      
      /* --- ESTILOS PARA TOOLTIPS --- */
      .tooltip-container {
        position: relative;
        display: inline-flex;
        align-items: center;
        margin-left: 8px;
      }
      .tooltip-icon {
        color: var(--muted);
        cursor: pointer;
        font-size: 0.9em;
        transition: color 0.3s ease;
      }
      .tooltip-container:hover .tooltip-icon {
        color: var(--accent);
      }
      .tooltip-text {
        visibility: hidden;
        width: 320px;
        background-color: #1a2433;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 10;
        bottom: 150%;
        left: 50%;
        margin-left: -160px;
        opacity: 0;
        transition: opacity 0.3s;
        font-weight: 400;
        font-size: 0.85rem;
        line-height: 1.5;
        border: 1px solid var(--card-border);
      }
      .tooltip-text p {
        margin-bottom: 8px;
      }
      .tooltip-text p:last-child {
        margin-bottom: 0;
      }
      .tooltip-text strong {
        color: var(--accent);
        font-weight: 600;
      }
      .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1a2433 transparent transparent transparent;
      }


      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 8px;
        margin-bottom: 15px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        background: rgba(0, 0, 0, 0.2);
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--card-border);
        transition: border-color 0.3s ease;
      }
      
      .checkbox-item:has(input:checked) {
        border-color: var(--accent);
      }
      
      .checkbox-item:hover {
        border-color: var(--accent);
      }

      /* --- ESTILOS PARA RADIOS E CHECKBOXES --- */
      .checkbox-item input[type="checkbox"],
      .checkbox-item input[type="radio"] {
        opacity: 0;
        position: absolute;
        width: 1px;
        height: 1px;
      }

      .checkbox-item label {
        position: relative;
        padding-left: 28px;
        cursor: pointer;
        display: inline-block;
        line-height: 20px;
        margin: 0;
        transition: color 0.3s ease;
        font-size: 0.9rem;
        font-weight: 400;
      }

      .checkbox-item:hover label,
      .checkbox-item input:checked + label {
        color: white;
      }
      
      .checkbox-item label::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 18px;
        height: 18px;
        border: 2px solid var(--muted);
        background-color: transparent;
        transition: all 0.2s ease;
      }
      
      .checkbox-item:hover label::before,
      .checkbox-item input:checked + label::before {
        border-color: var(--accent);
      }

      .checkbox-item input[type="radio"] + label::before {
        border-radius: 50%;
      }

      .checkbox-item input[type="checkbox"] + label::before {
        border-radius: 4px;
      }

      .checkbox-item label::after {
        content: '';
        position: absolute;
        transform: scale(0);
        transition: all 0.2s ease;
      }

      .checkbox-item input[type="radio"] + label::after {
        left: 4px;
        top: 4px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--accent);
      }
      
      .checkbox-item input[type="checkbox"] + label::after {
        left: 6px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid var(--accent);
        border-width: 0 2px 2px 0;
        transform: rotate(45deg) scale(0);
      }
      
      .checkbox-item input:checked + label::after {
        transform: scale(1);
      }
      
      .checkbox-item input[type="checkbox"]:checked + label::after {
        transform: rotate(45deg) scale(1);
      }

      textarea,
      input[type="text"],
      input[type="number"] {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        margin-top: 5px;
        background: rgba(0, 0, 0, 0.2);
        color: white;
        resize: vertical;
        font-family: "Lato", sans-serif;
      }

      textarea {
        min-height: 80px;
      }

      textarea::placeholder, input::placeholder {
        color: var(--muted);
        font-family: "Lato", sans-serif;
      }

      .btn-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-save {
        background-color: var(--success);
        color: white;
      }

      .btn-save:hover {
        background-color: #0da271;
      }

      .btn-reset {
        background-color: var(--danger);
        color: white;
      }

      .btn-reset:hover {
        background-color: #dc2626;
      }

      .btn-print {
        background-color: var(--accent);
        color: white;
      }

      .btn-print:hover {
        background-color: #3b82f6;
      }

      .btn-warning {
        background-color: var(--warning);
        color: white;
      }

      .btn-warning:hover {
        background-color: #d97706;
      }

      .reports-list {
        margin-top: 20px;
      }

      .report-item {
        padding: 15px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        margin-bottom: 10px;
        background: var(--glass);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .report-info {
        flex: 1;
        min-width: 250px;
      }

      .report-info h3 {
        color: var(--accent);
        margin-bottom: 5px;
      }

      .report-info p {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .report-actions {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
      }

      .report-btn {
        padding: 8px 12px;
        font-size: 14px;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
      }

      .modal-container {
        background-color: var(--card);
        margin: auto;
        padding: 25px;
        border: 1px solid var(--card-border);
        width: 90%;
        max-width: 900px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--glass);
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        color: var(--accent);
        font-size: 1.6rem;
      }

      .modal-close-btn {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 2.5rem;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        padding: 0;
      }

      .modal-close-btn:hover {
        color: white;
      }

      .modal-body {
        overflow-y: auto;
        padding-right: 15px;
      }

      .modal-body h3 {
        color: var(--accent);
        margin-top: 20px;
        margin-bottom: 10px;
        border-left: 3px solid var(--accent);
        padding-left: 10px;
      }

      .modal-body p,
      .modal-body li {
        color: #d1d5db;
        line-height: 1.7;
      }

      .modal-body strong {
        color: #e5e7eb;
        font-weight: 600;
      }

      .modal-body .report-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .modal-body .grid-item {
        background: var(--glass);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--card-border);
      }

      .modal-body .grid-item strong {
        display: block;
        margin-bottom: 5px;
        color: var(--muted);
      }

      .modal-footer {
        padding-top: 20px;
        margin-top: 20px;
        border-top: 1px solid var(--glass);
        display: flex;
        justify-content: flex-end;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .floating-save-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 15px;
      }

      .progress-indicator {
        background: var(--glass);
        padding: 12px 20px;
        border-radius: 50px;
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .progress-bar {
        width: 100px;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent);
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      .floating-main-btn {
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(25, 196, 182, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        padding: 0;
      }

      .floating-main-btn:hover {
        background-color: #15a89c;
        transform: translateY(-2px);
      }

      .floating-main-btn .fas {
        transition: transform 0.3s ease;
      }

      .floating-save-container.active .floating-main-btn .fas {
        transform: rotate(135deg);
      }

      .floating-actions-menu {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
      }

      .floating-action-btn {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 18px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transform: scale(0);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform-origin: bottom right;
      }

      .floating-save-container.active .floating-action-btn {
        transform: scale(1);
        opacity: 1;
      }

      .floating-action-btn.floating-save-final-btn {
        background-color: var(--success);
        color: white;
        transition-delay: 0.1s;
      }

      .floating-action-btn.floating-save-draft-btn {
        background-color: var(--warning);
        color: white;
        transition-delay: 0.05s;
      }
      
      .status-draft {
        color: var(--warning);
        font-size: 0.8rem;
        font-weight: 700;
        margin-left: 8px;
        vertical-align: middle;
      }
      
      /* --- MEDIA QUERIES PARA RESPONSIVIDADE --- */
      @media (max-width: 768px) {
        body {
            padding: 5px;
        }
        .container {
            padding: 15px;
        }
        header {
            flex-direction: column;
            align-items: stretch;
        }
        .logo-section {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .auth-section {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .report-item {
            flex-direction: column;
            align-items: stretch;
        }
        .report-actions {
            justify-content: space-between;
        }
        .report-btn {
            flex-grow: 1;
            justify-content: center;
        }
      }

      @media print {
        body > *:not(.modal-print-area) {
          display: none;
        }
        .modal-print-area {
          display: block !important;
        }
        .modal-container {
          box-shadow: none;
          border: none;
          max-height: none;
          color: black;
          background: white;
        }
        .modal-body h3,
        .modal-header h2 {
          color: #333;
          border-left-color: #333;
        }
        .modal-body p,
        .modal-body li,
        .modal-body strong {
          color: #333;
        }
        .modal-footer,
        .modal-close-btn {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo-section">
          <div class="logo">
            <img
              src="https://raw.githubusercontent.com/emerkaspar/analise-ri/refs/heads/main/logo.png"
              alt="Checklist de Análise de FIIs"
            />
          </div>
          <div class="titles">
            <h1 style="color: #19c4b6">Fundoscópio</h1>
            <p class="app-description">
              Ferramenta Completa de Análise de FII's para alunos da mentoria
              Geração Dividendos.
            </p>
          </div>
        </div>

        <div class="auth-section" id="auth-section">
            <button id="login-btn">
                <i class="fas fa-sign-in-alt"></i> Fazer Login com Google
            </button>
        
            <div id="user-info" style="display: none;">
                <button class="user-profile-button" id="user-profile-button">
                    <img id="user-avatar" src="" alt="User Avatar">
                    <span id="user-display-name"></span>
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="dropdown-user-info">
                        <h4 id="dropdown-user-name"></h4>
                        <p id="dropdown-user-email"></p>
                    </div>
                    <ul class="dropdown-actions">
                        <li><button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</button></li>
                    </ul>
                </div>
            </div>
        </div>
      </header>

      <div class="tabs">
        <div class="tab active" data-tab="form">Nova Análise</div>
        <div class="tab" data-tab="reports">Relatórios Salvos</div>
        <div class="tab" data-tab="help">Ajuda</div>
      </div>

      <div class="tab-content active" id="form-tab">
        <div id="analysis-choice-container">
            <div class="choice-card" id="choice-card-paper">
                <div class="choice-card-header">
                    <i class="fas fa-file-invoice-dollar fa-2x"></i>
                    <i class="fas fa-arrow-right"></i>
                </div>
                <h3>Análise de FIIs de Papel</h3>
                <p>Focada em recebíveis (CRIs), garantias e saúde dos devedores.</p>
            </div>
            <div class="choice-card" id="choice-card-tijolo">
                <div class="choice-card-header">
                    <i class="fas fa-building fa-2x"></i>
                    <i class="fas fa-arrow-right"></i>
                </div>
                <h3>Análise de FIIs de Tijolo</h3>
                <p>Focada em imóveis físicos, vacância, contratos e qualidade dos inquilinos.</p>
            </div>
        </div>

        <div id="analysis-form-container" style="display: none;">
            <button type="button" class="btn-switch-analysis" id="switch-analysis-btn">
                <i class="fas fa-exchange-alt"></i> Trocar Tipo de Análise
            </button>
            <form id="checklist-form">
            <div class="fund-info">
                <input type="text" id="fund-name" placeholder="Nome do Fundo" />
                <input
                type="text"
                id="analysis-date"
                placeholder="Mês/Ano de Referência (MM/AAAA)"
                />
                <input
                type="text"
                id="analyst-name"
                placeholder="Nome do Analista"
                />
            </div>
            
            <div id="paper-section" class="section" style="display: none">
                <div class="section-title">
                <span>📄</span>
                <h2>Análise de Fundos de Papel</h2>
                </div>
                <div class="checklist-item">
              <label>Alocação do Fundo</label>
              <div style="display: flex; gap: 10px; margin-top: 8px">
                <input
                  type="text"
                  id="allocation-cri-cra"
                  placeholder="% CRI/CRA"
                /><input
                  type="text"
                  id="allocation-fiis-paper"
                  placeholder="% FIIs"
                /><input
                  type="text"
                  id="allocation-cash-paper"
                  placeholder="% Caixa"
                />
              </div>
            </div>
            <div class="checklist-item">
              <label for="credits-count">Quantidade de créditos</label
              ><input
                type="number"
                id="credits-count"
                placeholder="Número total de créditos"
              />
            </div>
            <div class="checklist-item">
              <label>Indexador do fundo</label>
              <div style="display: flex; gap: 10px; margin-top: 8px">
                <input type="text" id="indexer-cdi" placeholder="% CDI" /><input
                  type="text"
                  id="indexer-ipca"
                  placeholder="% IPCA"
                />
              </div>
            </div>
            <div class="checklist-item">
              <label>Taxa média dos créditos</label>
              <div style="display: flex; gap: 10px; margin-top: 8px">
                <input
                  type="text"
                  id="credit-rate-cdi"
                  placeholder="CDI+X%"
                /><input
                  type="text"
                  id="credit-rate-ipca"
                  placeholder="IPCA+X%"
                />
              </div>
            </div>
            <div class="checklist-item">
              <label for="credit-duration"
                >Duration da carteira de créditos (anos)</label
              ><input
                type="text"
                id="credit-duration"
                placeholder="Duration média em anos"
              />
            </div>
            <div class="checklist-item">
              <label>Garantias praticadas pelo fundo:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-fiduciary-alienation"
                    name="warranty"
                  /><label for="warranty-fiduciary-alienation"
                    >Alienação fiduciária</label
                  >
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-fiduciary-cession"
                    name="warranty"
                  /><label for="warranty-fiduciary-cession"
                    >Cessão fiduciária</label
                  >
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-mortgage"
                    name="warranty"
                  /><label for="warranty-mortgage">Hipoteca</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-reserves"
                    name="warranty"
                  /><label for="warranty-reserves">Reservas</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-guarantors"
                    name="warranty"
                  /><label for="warranty-guarantors">Fiadores</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-participation"
                    name="warranty"
                  /><label for="warranty-participation">Participação</label
                  >
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="warranty-rating"
                    name="warranty"
                  /><label for="warranty-rating">Rating</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Fundo possui créditos sem garantias?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="unsecured-credits-yes"
                    name="unsecured-credits"
                    value="sim"
                  /><label for="unsecured-credits-yes">Sim</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="unsecured-credits-no"
                    name="unsecured-credits"
                    value="nao"
                  /><label for="unsecured-credits-no">Não</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="average-ltv"
                >LTV médio (razão entre o valor do crédito e o valor da
                garantia)</label
              ><input
                type="text"
                id="average-ltv"
                placeholder="LTV médio em %"
              />
            </div>
            <div class="checklist-item">
              <label for="debtor-segments"
                >Segmentos de mercado dos devedores</label
              ><textarea
                id="debtor-segments"
                placeholder="Liste os segmentos de mercado dos devedores..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="debtor-concentration"
                >Concentração da carteira em algum devedor? Qual devedor e
                %</label
              ><textarea
                id="debtor-concentration"
                placeholder="Descreva a concentração em devedores..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="main-debtor-financials"
                >Situação financeira do devedor com maior concentração</label
              ><textarea
                id="main-debtor-financials"
                placeholder="Descreva a situação financeira do principal devedor..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre fundos de papel..."
              ></textarea>
            </div>
            </div>

            <div id="tijolo-section" class="section" style="display: none">
                <div class="section-title">
                <span>🧱</span>
                <h2>Análise de FIIs de Tijolo</h2>
                </div>
                <div class="checklist-item">
              <label>Segmento principal do fundo?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="logistics" name="segment" /><label
                    for="logistics"
                    >📦 Logística</label
                  >
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="offices" name="segment" /><label
                    for="offices"
                    >🏢 Lajes</label
                  >
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="shoppings" name="segment" /><label
                    for="shoppings"
                    >🛍️ Shoppings</label
                  >
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="other-segment"
                    name="segment"
                  /><label for="other-segment">📍 Outros</label>
                </div>
              </div>
              <input
                type="text"
                id="other-segment-text"
                placeholder="Especifique outros segmentos"
                style="margin-top: 10px; display: none"
              />
            </div>
            <div class="checklist-item">
              <label for="property-count">Quantidade de imóveis</label
              ><input
                type="number"
                id="property-count"
                placeholder="Número de imóveis no portfólio"
              />
            </div>
            <div class="checklist-item">
              <label>Alocação do Fundo</label>
              <div style="display: flex; gap: 10px; margin-top: 8px">
                <input
                  type="text"
                  id="allocation-properties"
                  placeholder="% Imóveis"
                /><input
                  type="text"
                  id="allocation-fiis"
                  placeholder="% FIIs"
                /><input
                  type="text"
                  id="allocation-cash"
                  placeholder="% Caixa"
                />
              </div>
            </div>
            <div class="checklist-item">
              <label>% de contratos</label>
              <div style="display: flex; gap: 10px; margin-top: 8px">
                <input
                  type="text"
                  id="typical-contracts"
                  placeholder="% Típicos"
                /><input
                  type="text"
                  id="atypical-contracts"
                  placeholder="% Atípicos"
                />
              </div>
            </div>
            <div class="checklist-item">
              <label for="average-contract-term"
                >Tempo médio de vencimento dos contratos (meses)</label
              ><input
                type="number"
                id="average-contract-term"
                placeholder="Tempo médio em meses"
              />
            </div>
            <div class="checklist-item">
              <label for="expiring-contracts"
                >Há contratos próximos do vencimento? Qual % da receita?</label
              ><textarea
                id="expiring-contracts"
                placeholder="Descreva a situação dos contratos..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="active-tenants">Quantos inquilinos ativos</label
              ><input
                type="number"
                id="active-tenants"
                placeholder="Número de inquilinos ativos"
              />
            </div>
            <div class="checklist-item">
              <label for="tenant-segments"
                >Segmentos de mercado dos inquilinos</label
              ><textarea
                id="tenant-segments"
                placeholder="Liste os segmentos de mercado..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="largest-sector"
                >% da carteira alocada no maior setor</label
              ><input
                type="text"
                id="largest-sector"
                placeholder="Percentual do maior setor"
              />
            </div>
            <div class="checklist-item">
              <label for="tenant-concentration"
                >Concentração em algum inquilino? Qual e qual %?</label
              ><textarea
                id="tenant-concentration"
                placeholder="Descreva a concentração..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="tenant-financials"
                >Situação financeira do inquilino com maior concentração</label
              ><textarea
                id="tenant-financials"
                placeholder="Descreva a situação financeira..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Existe inquilino em período de carência?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="grace-period-yes"
                    name="grace-period"
                    value="sim"
                  /><label for="grace-period-yes">Sim</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="grace-period-no"
                    name="grace-period"
                    value="nao"
                  /><label for="grace-period-no">Não</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre a estrutura do fundo..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>🏦</span>
                <h2>Estrutura do Fundo</h2>
                </div>
                <div class="checklist-item">
              <label
                >Qual a estratégia/objetivo do fundo? (renda, ganho de capital,
                reciclagem de portfólio, etc.)</label
              ><textarea
                id="strategy"
                placeholder="Descreva a estratégia do fundo..."
              ></textarea>
            </div>

            <div class="checklist-item">
              <label>Tipo de gestão:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="active-management"
                    name="management-type"
                    value="ativa"
                  /><label for="active-management">Ativa</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="passive-management"
                    name="management-type"
                    value="passiva"
                  /><label for="passive-management">Passiva</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Comparação com IFIX:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="above-ifix"
                    name="ifix-comparison"
                    value="acima"
                  /><label for="above-ifix">📈 Acima</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="below-ifix"
                    name="ifix-comparison"
                    value="abaixo"
                  /><label for="below-ifix">📉 Abaixo</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="with-ifix"
                    name="ifix-comparison"
                    value="junto"
                  /><label for="with-ifix">➡️ Junto</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="admin-fee">Taxa de administração (%)</label
              ><input
                type="text"
                id="admin-fee"
                placeholder="Taxa de administração em %"
              />
            </div>
            <div class="checklist-item">
              <label for="performance-fee">Taxa de performance (%)</label
              ><input
                type="text"
                id="performance-fee"
                placeholder="Taxa de performance em %"
              />
            </div>
            <div class="checklist-item">
              <label for="ffo-vs-dy">Valor do FFO vs DY</label
              ><input
                type="text"
                id="ffo-vs-dy"
                placeholder="Comparação entre FFO e DY"
              />
            </div>
            <div class="checklist-item">
              <label for="extraordinary-revenue"
                >Se o FFO está abaixo do DY, fundo tem gerado receita
                extraordinária? Tem bastante saldo acumulado?</label
              ><textarea
                id="extraordinary-revenue"
                placeholder="Descreva a situação da receita extraordinária e saldo acumulado..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>🔎</span>
                <h2>Governança e Gestão</h2>
                </div>
                <div class="checklist-item">
              <label for="manager-history"
                >Quem é o gestor e qual o histórico dela no mercado?</label
              ><textarea
                id="manager-history"
                placeholder="Descreva o gestor e seu histórico..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Existe troca de gestor ou equipe recente?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="manager-change-yes"
                    name="manager-change"
                    value="sim"
                  /><label for="manager-change-yes">Sim</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="manager-change-no"
                    name="manager-change"
                    value="nao"
                  /><label for="manager-change-no">Não</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="manager-change-details"
                >Se houve troca, detalhe as circunstâncias:</label
              ><textarea
                id="manager-change-details"
                placeholder="Detalhe a troca de gestão..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label
                >O fundo tem conflitos de interest (gestor/administrador ligados
                a ativos/inquilinos)?</label
              >
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="conflicts-yes"
                    name="conflicts"
                    value="sim"
                  /><label for="conflicts-yes">Sim</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="conflicts-no"
                    name="conflicts"
                    value="nao"
                  /><label for="conflicts-no">Não</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="conflicts-details"
                >Se houver conflitos, detalhe:</label
              ><textarea
                id="conflicts-details"
                placeholder="Descreva os conflitos de interesse..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Grau de transparência dos relatórios:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="transparency-high"
                    name="transparency"
                    value="alta"
                  /><label for="transparency-high"
                    >Alta (claros and detalhados)</label
                  >
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="transparency-medium"
                    name="transparency"
                    value="media"
                  /><label for="transparency-medium">Média</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="transparency-low"
                    name="transparency"
                    value="baixa"
                  /><label for="transparency-low">Baixa (superficiais)</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre governança e gestão..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>📊</span>
                <h2>Vacância e Receita</h2>
                </div>
                 <div class="checklist-item">
              <label for="financial-vacancy">Vacância financeira (%)</label
              ><input
                type="text"
                id="financial-vacancy"
                placeholder="Percentual de vacância financeira"
              />
            </div>
            <div class="checklist-item">
              <label for="physical-vacancy">Vacância física (%)</label
              ><input
                type="text"
                id="physical-vacancy"
                placeholder="Percentual de vacância física"
              />
            </div>
            <div class="checklist-item">
              <label for="default-rate">Inadimplência (%)</label
              ><input
                type="text"
                id="default-rate"
                placeholder="Percentual de inadimplência"
              />
            </div>
            <div class="checklist-item">
              <label>Resultado superior ou inferior ao mês anterior?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="result-higher"
                    name="result-comparison"
                    value="superior"
                  /><label for="result-higher">Superior</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="result-lower"
                    name="result-comparison"
                    value="inferior"
                  /><label for="result-lower">Inferior</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="result-same"
                    name="result-comparison"
                    value="igual"
                  /><label for="result-same">Igual</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="result-reason">Se diferente, qual o motivo?</label
              ><textarea
                id="result-reason"
                placeholder="Explique o motivo da variação..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre vacância and receita..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>📈</span>
                <h2>Desempenho Comparativo</h2>
                </div>
                 <div class="checklist-item">
              <label for="vpc-evolution"
                >Evolução do valor patrimonial por cota (VPC) nos últimos 12
                meses</label
              ><textarea
                id="vpc-evolution"
                placeholder="Descreva a evolução do VPC..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="current-vs-avg"
                >Cotação atual vs média dos últimos 12 meses</label
              ><input
                type="text"
                id="current-vs-avg"
                placeholder="Ex: 5% acima, 10% abaixo"
              />
            </div>
            <div class="checklist-item">
              <label for="yield-comparison"
                >Rendimento atual vs média histórica (em %)</label
              ><input
                type="text"
                id="yield-comparison"
                placeholder="Ex: 6.5% vs 7.2%"
              />
            </div>
            <div class="checklist-item">
              <label for="sector-comparison"
                >DY vs média do setor (logística, lajes, shopping, etc.)</label
              ><input
                type="text"
                id="sector-comparison"
                placeholder="Ex: 0.5% acima da média de shoppings"
              />
            </div>
            <div class="checklist-item">
              <label>Classificação do fundo:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="risk-fund"
                    name="fund-classification"
                  /><label for="risk-fund">⚠️ Risco</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="growth-fund"
                    name="fund-classification"
                  /><label for="growth-fund">📈 Crescimento</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="checkbox"
                    id="anchor-fund"
                    name="fund-classification"
                  /><label for="anchor-fund">⚓ Ancoragem</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre desempenho comparativo..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>💰</span>
                <h2>Alavancagem e Estrutura de Capital</h2>
                </div>
                 <div class="checklist-item">
              <label>Existe alavancagem?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="leverage-yes"
                    name="leverage"
                    value="sim"
                  /><label for="leverage-yes">Sim</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="leverage-no"
                    name="leverage"
                    value="nao"
                  /><label for="leverage-no">Não</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="leverage-rate">Taxa média da alavancagem (%)</label
              ><input
                type="text"
                id="leverage-rate"
                placeholder="Taxa média de juros"
              />
            </div>
            <div class="checklist-item">
              <label for="amortization-plan"
                >Plano de amortização detalhado</label
              ><textarea
                id="amortization-plan"
                placeholder="Descreva o plano de amortização..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre alavancagem..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>📈</span>
                <h2>Liquidez e Mercado</h2>
                </div>
                <div class="checklist-item">
              <label>Liquidez: estabilizada, crescente ou decrescente?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="liquidity-stable"
                    name="liquidity"
                    value="estavel"
                  /><label for="liquidity-stable">Estabilizada</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="liquidity-increasing"
                    name="liquidity"
                    value="crescente"
                  /><label for="liquidity-increasing">Crescente</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="liquidity-decreasing"
                    name="liquidity"
                    value="decrescente"
                  /><label for="liquidity-decreasing">Decrescente</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="important-notices"
                >Comunicados importantes no período (aquisições, vendas, novos
                contratos, problemas com inquilinos)</label
              ><textarea
                id="important-notices"
                placeholder="Liste os comunicados importantes..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre liquidez e mercado..."
              ></textarea>
            </div>
            </div>

            <div class="section">
                <div class="section-title">
                <span>⚖️</span>
                <h2>Avaliação de Risco e Oportunidade</h2>
                </div>
                 <div class="checklist-item">
              <label>Risco: baixo / médio / alto?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="risk-low"
                    name="risk-level"
                    value="baixo"
                  /><label for="risk-low">Baixo</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="risk-medium"
                    name="risk-level"
                    value="medio"
                  /><label for="risk-medium">Médio</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="risk-high"
                    name="risk-level"
                    value="alto"
                  /><label for="risk-high">Alto</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label for="main-risks"
                >Principais riscos elencados (ex.: concentração, vacância,
                endividamento, setor específico)</label
              ><textarea
                id="main-risks"
                placeholder="Liste os principais riscos..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="opportunities"
                >Existem oportunidades claras? (ex.: nova ancoragem, desconto de
                mercado, potencial de crescimento)</label
              ><textarea
                id="opportunities"
                placeholder="Descreva as oportunidades..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>O fundo apresenta ancoragem sólida?</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="anchor-yes"
                    name="anchor"
                    value="sim"
                  /><label for="anchor-yes">Sim</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="anchor-no"
                    name="anchor"
                    value="nao"
                  /><label for="anchor-no">Não</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="anchor-partial"
                    name="anchor"
                    value="parcial"
                  /><label for="anchor-partial">Parcialmente</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Observações:</label
              ><textarea
                class="observations"
                placeholder="Anotações sobre risco e oportunidade..."
              ></textarea>
            </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                <span>✅</span>
                <h2>Conclusão da Análise</h2>
                </div>
                 <div class="checklist-item">
              <label for="positive-points">Pontos positivos:</label
              ><textarea
                id="positive-points"
                placeholder="Liste os pontos positivos..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="negative-points">Pontos negativos:</label
              ><textarea
                id="negative-points"
                placeholder="Liste os pontos negativos..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="cash-burn"
                >Fundo está queimando caixa? Se sim, por quê?</label
              ><textarea
                id="cash-burn"
                placeholder="Descreva a situação de caixa..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label for="balance-sustainability"
                >O saldo acumulado sustentará a distribution por quanto
                tempo?</label
              ><input
                type="text"
                id="balance-sustainability"
                placeholder="Ex: 12 meses"
              />
            </div>
            <div class="checklist-item">
              <label for="discount"
                >O fundo está descontado? Se sim, esse desconto é
                justificável?</label
              ><textarea
                id="discount"
                placeholder="Analise o desconto..."
              ></textarea>
            </div>
            <div class="checklist-item">
              <label>Expectativa para próximos resultados:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="expect-improve"
                    name="expectation"
                    value="melhora"
                  /><label for="expect-improve">Melhora</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="expect-stable"
                    name="expectation"
                    value="estabilidade"
                  /><label for="expect-stable">Estabilidade</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="expect-worse"
                    name="expectation"
                    value="piora"
                  /><label for="expect-worse">Piora</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Recomendação:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="recommend-follow"
                    name="recommendation"
                    value="acompanhar"
                  /><label for="recommend-follow">✔️ Acompanhar</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="recommend-increase"
                    name="recommendation"
                    value="aumentar"
                  /><label for="recommend-increase">✔️ Aumentar posição</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="recommend-reduce"
                    name="recommendation"
                    value="reduzir"
                  /><label for="recommend-reduce">✔️ Reduzir exposição</label>
                </div>
                <div class="checkbox-item">
                  <input
                    type="radio"
                    id="recommend-avoid"
                    name="recommendation"
                    value="evitar"
                  /><label for="recommend-avoid">✔️ Evitar</label>
                </div>
              </div>
            </div>
            <div class="checklist-item">
              <label>Observações finais:</label
              ><textarea
                class="observations"
                placeholder="Considerações finais..."
              ></textarea>
            </div>
            </div>


            <div class="btn-group">
                <button type="button" class="btn-save" id="save-btn">
                <i class="fas fa-check-circle"></i> Salvar Análise Final
                </button>
                <button type="button" class="btn-warning" id="save-draft-btn">
                <i class="fas fa-save"></i> Salvar Rascunho
                </button>
                <button type="reset" class="btn-reset">
                <i class="fas fa-trash"></i> Limpar Formulário
                </button>
            </div>
            </form>
        </div>
      </div>

      <div class="tab-content" id="reports-tab">
        <h2><i class="fas fa-file-alt"></i> Relatórios Salvos</h2>
        <p>Encontre e gerencie suas análises salvas</p>
        <div class="search-box">
          <input
            type="text"
            id="search-input"
            placeholder="Pesquisar por nome do fundo ou data..."
          />
          <button class="btn-save" id="search-btn">
            <i class="fas fa-search"></i> Pesquisar
          </button>
        </div>
        <div id="reports-message"></div>
        <div class="storage-info">
          <p>Relatórios salvos: <span id="reports-count">0</span></p>
          <button class="btn-reset" id="clear-all-btn">
            <i class="fas fa-trash"></i> Limpar Todos os Relatórios
          </button>
        </div>
        <div class="reports-list" id="reports-list"></div>
      </div>

      <div class="tab-content" id="help-tab">
        <h2><i class="fas fa-question-circle"></i> Ajuda e Informações</h2>
        <div class="section">
          <h3>Onde os relatórios são salvos?</h3>
          <p>
            Todos os relatórios são salvos na nuvem usando
            <strong>Firebase</strong>.
          </p>
          <p>
            Isso significa que você pode acessar suas análises de qualquer
            dispositivo após fazer login.
          </p>
        </div>
        <div class="section">
          <h3>Como pesquisar relatórios?</h3>
          <p>
            Na aba "Relatórios Salvos", digite o nome do fundo ou a data no
            campo de pesquisa e clique no botão "Pesquisar".
          </p>
          <p>
            Você também pode visualizar, carregar ou excluir relatórios
            individualmente usando os botões ao lado de cada relatório.
          </p>
        </div>
        <div class="section">
          <h3>Como imprimir ou exportar?</h3>
          <p>
            Use o botão "Imprimir/Exportar" na aba de Nova Análise para gerar
            uma versão para impressão do formulário atual.
          </p>
          <p>
            Na visualização de impressão, você pode salvar como PDF usando a
            função "Salvar como PDF" do seu navegador.
          </p>
        </div>
        <div class="section">
          <h3>Os dados serão perdidos se eu limpar o navegador?</h3>
          <p>
            Não, pois os dados são salvos na nuvem. Se você limpar o histórico e
            dados de navegação, basta fazer login novamente para recuperar suas
            análises.
          </p>
        </div>
      </div>
    </div>

    <div class="floating-save-container" id="floating-save-container">
      <div class="floating-actions-menu">
        <button
          class="floating-action-btn floating-save-draft-btn"
          id="floating-save-draft-btn"
          title="Salvar Rascunho"
        >
          <i class="fas fa-save"></i>
        </button>
        <button
          class="floating-action-btn floating-save-final-btn"
          id="floating-save-final-btn"
          title="Salvar Análise Final"
        >
          <i class="fas fa-check-circle"></i>
        </button>
      </div>
      <button class="floating-main-btn" id="floating-main-btn">
        <i class="fas fa-plus"></i>
      </button>
      <div class="progress-indicator">
        <span>Preenchimento: </span>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <span id="progress-percentage">0%</span>
      </div>
    </div>

    <div id="report-modal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h2 id="modal-title">Detalhes do Relatório</h2>
          <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-footer">
          <button id="modal-print-btn" class="btn-print">
            <i class="fas fa-print"></i> Imprimir Relatório
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- CONSTANTES ---
        const firebaseConfig = {
          apiKey: "AIzaSyDCplzRR5imGdGCpr6PnKEwo2rs5qPrV6c",
          authDomain: "rianalise.firebaseapp.com",
          projectId: "rianalise",
          storageBucket: "rianalise.appspot.com",
          messagingSenderId: "46433102386",
          appId: "1:46433102386:web:918bfbc2f0834604daaa2b",
          measurementId: "G-ZQ2178VY8N",
        };

        let db = null;
        let auth = null;
        let isFirebaseInitialized = false;

        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          db = firebase.firestore();
          auth = firebase.auth();
          isFirebaseInitialized = true;
        } catch (error) {
          console.error("Erro ao inicializar Firebase:", error);
        }

        const tabs = document.querySelectorAll(".tab");
        const tabContents = document.querySelectorAll(".tab-content");
        const otherSegmentCheckbox = document.getElementById("other-segment");
        const otherSegmentText = document.getElementById("other-segment-text");
        const saveBtn = document.getElementById("save-btn");
        const saveDraftBtn = document.getElementById("save-draft-btn");
        const floatingSaveContainer = document.getElementById(
          "floating-save-container"
        );
        const floatingMainBtn = document.getElementById("floating-main-btn");
        const floatingSaveFinalBtn = document.getElementById(
          "floating-save-final-btn"
        );
        const floatingSaveDraftBtn = document.getElementById(
          "floating-save-draft-btn"
        );
        const searchBtn = document.getElementById("search-btn");
        const searchInput = document.getElementById("search-input");
        const clearAllBtn = document.getElementById("clear-all-btn");
        const reportsList = document.getElementById("reports-list");
        const reportsCount = document.getElementById("reports-count");
        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const userInfo = document.getElementById("user-info");
        const userProfileButton = document.getElementById("user-profile-button");
        const userDropdown = document.getElementById("user-dropdown");
        
        const progressFill = document.getElementById("progress-fill");
        const progressPercentage = document.getElementById(
          "progress-percentage"
        );
        const reportModal = document.getElementById("report-modal");
        const modalCloseBtn = document.querySelector(".modal-close-btn");
        const modalPrintBtn = document.getElementById("modal-print-btn");
        
        // NOVOS ELEMENTOS
        const analysisChoiceContainer = document.getElementById('analysis-choice-container');
        const analysisFormContainer = document.getElementById('analysis-form-container');
        const choiceCardPaper = document.getElementById('choice-card-paper');
        const choiceCardTijolo = document.getElementById('choice-card-tijolo');
        const switchAnalysisBtn = document.getElementById('switch-analysis-btn');
        const paperSection = document.getElementById("paper-section");
        const tijoloSection = document.getElementById("tijolo-section");

        let currentUser = null;

        // --- LÓGICA DE EVENTOS ---

        saveBtn.addEventListener("click", () => saveFormData("finalizado"));
        saveDraftBtn.addEventListener("click", () => saveFormData("rascunho"));
        floatingSaveFinalBtn.addEventListener("click", () =>
          saveFormData("finalizado")
        );
        floatingSaveDraftBtn.addEventListener("click", () =>
          saveFormData("rascunho")
        );

        floatingMainBtn.addEventListener("click", () => {
          floatingSaveContainer.classList.toggle("active");
        });

        // NOVA LÓGICA DE SELEÇÃO INICIAL
        choiceCardPaper.addEventListener('click', () => selectAnalysisType('paper'));
        choiceCardTijolo.addEventListener('click', () => selectAnalysisType('tijolo'));
        switchAnalysisBtn.addEventListener('click', goBackToChoice);

        function selectAnalysisType(type) {
            analysisChoiceContainer.style.display = 'none';
            analysisFormContainer.style.display = 'block';
            if (type === 'paper') {
                paperSection.style.display = 'block';
                tijoloSection.style.display = 'none';
            } else { // tijolo
                paperSection.style.display = 'none';
                tijoloSection.style.display = 'block';
            }
            calculateFormProgress();
        }

        function goBackToChoice() {
            if (confirm("Voltar para a tela de seleção irá limpar o formulário. Deseja continuar?")) {
                document.getElementById("checklist-form").reset();
            }
        }


        document
          .getElementById("checklist-form")
          .addEventListener("reset", () => {
            paperSection.style.display = "none";
            tijoloSection.style.display = "none";
            analysisFormContainer.style.display = 'none';
            analysisChoiceContainer.style.display = 'flex';
            setTimeout(calculateFormProgress, 100);
          });

        if (isFirebaseInitialized) {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loginBtn.style.display = 'none';
                    userInfo.style.display = 'block';

                    document.getElementById('user-avatar').src = user.photoURL || '';
                    document.getElementById('user-display-name').textContent = user.displayName || user.email;
                    document.getElementById('dropdown-user-name').textContent = user.displayName || 'Usuário';
                    document.getElementById('dropdown-user-email').textContent = user.email;

                    if (document.querySelector(".tab.active").getAttribute("data-tab") === "reports") {
                        updateReportsList();
                    }
                } else {
                    currentUser = null;
                    loginBtn.style.display = 'block';
                    userInfo.style.display = 'none';
                    if (document.querySelector(".tab.active").getAttribute("data-tab") === "reports") {
                        reportsList.innerHTML = "<p>Faça login para ver seus relatórios salvos.</p>";
                    }
                }
            });
        }


        loginBtn.addEventListener("click", () => {
          if (!isFirebaseInitialized) {
            alert(
              "Firebase não inicializado. Verifique sua conexão com a internet."
            );
            return;
          }
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch((error) => {
            console.error("Erro no login:", error);
            alert("Erro ao fazer login: " + error.message);
          });
        });

        logoutBtn.addEventListener("click", () => {
          if (isFirebaseInitialized) {
            auth.signOut();
          }
        });

        userProfileButton.addEventListener("click", (event) => {
            event.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        document.addEventListener("click", (event) => {
            if (!userDropdown.contains(event.target) && !userProfileButton.contains(event.target)) {
                userDropdown.classList.remove('active');
            }
        });


        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const tabId = tab.getAttribute("data-tab");
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            tabContents.forEach((content) => {
              content.classList.remove("active");
              if (content.id === `${tabId}-tab`) {
                content.classList.add("active");
              }
            });
            if (tabId === "form") {
              floatingSaveContainer.style.display = "flex";
              calculateFormProgress();
            } else {
              floatingSaveContainer.style.display = "none";
            }
            if (tabId === "reports") {
              updateReportsList();
            }
          });
        });

        otherSegmentCheckbox.addEventListener("change", function () {
          otherSegmentText.style.display = this.checked ? "block" : "none";
        });

        modalCloseBtn.addEventListener("click", () => {
          reportModal.style.display = "none";
        });
        modalPrintBtn.addEventListener("click", () => {
          document.body.classList.add("modal-print-area");
          reportModal.classList.add("modal-print-area");
          window.print();
          document.body.classList.remove("modal-print-area");
          reportModal.classList.remove("modal-print-area");
        });

        const today = new Date();
        const month = today.getMonth() + 1;
        const year = today.getFullYear();
        document.getElementById("analysis-date").value = `${month
          .toString()
          .padStart(2, "0")}/${year}`;

        document
          .querySelectorAll(
            "#checklist-form input, #checklist-form textarea, #checklist-form select"
          )
          .forEach((input) => {
            input.addEventListener("input", calculateFormProgress);
            input.addEventListener("change", calculateFormProgress);
          });
        calculateFormProgress();

        // --- FUNÇÕES ---

        async function saveFormData(status = "finalizado") {
          if (!isFirebaseInitialized || !currentUser) {
            alert("Faça login para salvar suas análises.");
            return;
          }
          const fundName = document.getElementById("fund-name").value;
          const analysisDate = document.getElementById("analysis-date").value;

          if (!fundName || !analysisDate) {
            alert(
              "Por favor, informe o Nome do Fundo e o Mês/Ano de Referência antes de salvar."
            );
            return;
          }

          const originalTextSave = saveBtn.innerHTML;
          const originalTextDraft = saveDraftBtn.innerHTML;
          const buttonsToDisable = [
            saveBtn,
            saveDraftBtn,
            floatingSaveFinalBtn,
            floatingSaveDraftBtn,
          ];

          buttonsToDisable.forEach((btn) => {
            btn.innerHTML = '<span class="loading"></span> Salvando...';
            btn.disabled = true;
          });

          try {
            const querySnapshot = await db
              .collection("analises")
              .where("userId", "==", currentUser.uid)
              .where("fundName", "==", fundName)
              .where("analysisDate", "==", analysisDate)
              .limit(1)
              .get();

            const formData = {
              fundName,
              analysisDate,
              analystName: document.getElementById("analyst-name").value,
              strategy: document.getElementById("strategy").value,
              segments: getSelectedCheckboxes("segment"),
              otherSegment: document.getElementById("other-segment-text").value,
              managementType: getSelectedRadio("management-type"),
              ifixComparison: getSelectedRadio("ifix-comparison"),
              propertyCount: document.getElementById("property-count").value,
              allocationProperties: document.getElementById(
                "allocation-properties"
              ).value,
              allocationFiis: document.getElementById("allocation-fiis").value,
              allocationCash: document.getElementById("allocation-cash").value,
              typicalContracts:
                document.getElementById("typical-contracts").value,
              atypicalContracts:
                document.getElementById("atypical-contracts").value,
              averageContractTerm: document.getElementById(
                "average-contract-term"
              ).value,
              adminFee: document.getElementById("admin-fee").value,
              performanceFee: document.getElementById("performance-fee").value,
              ffoVsDy: document.getElementById("ffo-vs-dy").value,
              extraordinaryRevenue: document.getElementById(
                "extraordinary-revenue"
              ).value,
              allocationCriCra:
                document.getElementById("allocation-cri-cra").value,
              allocationFiisPaper: document.getElementById(
                "allocation-fiis-paper"
              ).value,
              allocationCashPaper: document.getElementById(
                "allocation-cash-paper"
              ).value,
              creditsCount: document.getElementById("credits-count").value,
              indexerCdi: document.getElementById("indexer-cdi").value,
              indexerIpca: document.getElementById("indexer-ipca").value,
              creditRateCdi: document.getElementById("credit-rate-cdi").value,
              creditRateIpca: document.getElementById("credit-rate-ipca").value,
              creditDuration: document.getElementById("credit-duration").value,
              warranties: getSelectedCheckboxes("warranty"),
              unsecuredCredits: getSelectedRadio("unsecured-credits"),
              averageLtv: document.getElementById("average-ltv").value,
              debtorSegments: document.getElementById("debtor-segments").value,
              debtorConcentration: document.getElementById(
                "debtor-concentration"
              ).value,
              mainDebtorFinancials: document.getElementById(
                "main-debtor-financials"
              ).value,
              expiringContracts:
                document.getElementById("expiring-contracts").value,
              activeTenants: document.getElementById("active-tenants").value,
              tenantSegments: document.getElementById("tenant-segments").value,
              largestSector: document.getElementById("largest-sector").value,
              tenantConcentration: document.getElementById(
                "tenant-concentration"
              ).value,
              tenantFinancials:
                document.getElementById("tenant-financials").value,
              gracePeriod: getSelectedRadio("grace-period"),
              managerHistory: document.getElementById("manager-history").value,
              managerChange: getSelectedRadio("manager-change"),
              managerChangeDetails: document.getElementById(
                "manager-change-details"
              ).value,
              conflicts: getSelectedRadio("conflicts"),
              conflictsDetails:
                document.getElementById("conflicts-details").value,
              transparency: getSelectedRadio("transparency"),
              vpcEvolution: document.getElementById("vpc-evolution").value,
              currentVsAvg: document.getElementById("current-vs-avg").value,
              yieldComparison:
                document.getElementById("yield-comparison").value,
              sectorComparison:
                document.getElementById("sector-comparison").value,
              fundClassification: getSelectedCheckboxes("fund-classification"),
              financialVacancy:
                document.getElementById("financial-vacancy").value,
              physicalVacancy:
                document.getElementById("physical-vacancy").value,
              defaultRate: document.getElementById("default-rate").value,
              resultComparison: getSelectedRadio("result-comparison"),
              resultReason: document.getElementById("result-reason").value,
              leverage: getSelectedRadio("leverage"),
              leverageRate: document.getElementById("leverage-rate").value,
              amortizationPlan:
                document.getElementById("amortization-plan").value,
              liquidity: getSelectedRadio("liquidity"),
              importantNotices:
                document.getElementById("important-notices").value,
              riskLevel: getSelectedRadio("risk-level"),
              mainRisks: document.getElementById("main-risks").value,
              opportunities: document.getElementById("opportunities").value,
              anchor: getSelectedRadio("anchor"),
              positivePoints: document.getElementById("positive-points").value,
              negativePoints: document.getElementById("negative-points").value,
              cashBurn: document.getElementById("cash-burn").value,
              balanceSustainability: document.getElementById(
                "balance-sustainability"
              ).value,
              discount: document.getElementById("discount").value,
              expectation: getSelectedRadio("expectation"),
              recommendation: getSelectedRadio("recommendation"),
              observations: Array.from(
                document.querySelectorAll(".observations")
              )
                .map((t) => t.value)
                .filter((v) => v),
              status: status,
              timestamp: new Date().toISOString(),
            };

            const firebaseData = {
              ...formData,
              userId: currentUser.uid,
              userEmail: currentUser.email,
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            };

            if (!querySnapshot.empty) {
              const existingDoc = querySnapshot.docs[0];
              const confirmation = confirm(
                `Já existe uma análise para "${fundName}" em ${analysisDate}. Deseja sobrescrevê-la?`
              );

              if (confirmation) {
                await db
                  .collection("analises")
                  .doc(existingDoc.id)
                  .update(firebaseData);
                alert(`Análise de ${fundName} ATUALIZADA com sucesso!`);
              } else {
                alert("Operação de salvamento cancelada.");
              }
            } else {
              await db.collection("analises").add(firebaseData);
              alert(`Análise de ${fundName} salva com sucesso!`);
            }
          } catch (error) {
            console.error("Erro ao salvar: ", error);
            alert(
              `Erro ao salvar: ${error.message}. Se o erro mencionar 'índice', contate o suporte.`
            );
          } finally {
            saveBtn.innerHTML = originalTextSave;
            saveDraftBtn.innerHTML = originalTextDraft;
            buttonsToDisable.forEach((btn) => {
              if (btn.id === "floating-save-final-btn")
                btn.innerHTML = '<i class="fas fa-check-circle"></i>';
              else if (btn.id === "floating-save-draft-btn")
                btn.innerHTML = '<i class="fas fa-save"></i>';
              btn.disabled = false;
            });
            floatingSaveContainer.classList.remove("active");
          }
        }

        async function updateReportsList(searchTerm = "") {
          reportsList.innerHTML =
            '<p><span class="loading"></span> Carregando...</p>';

          if (!currentUser) {
            reportsList.innerHTML =
              "<p>Faça login para ver seus relatórios.</p>";
            return;
          }

          try {
            let query = db
              .collection("analises")
              .where("userId", "==", currentUser.uid)
              .orderBy("lastUpdated", "desc");
            const querySnapshot = await query.get();

            if (querySnapshot.empty) {
              reportsList.innerHTML = "<p>Nenhum relatório encontrado.</p>";
              reportsCount.textContent = 0;
              return;
            }

            let reports = [];
            querySnapshot.forEach((doc) =>
              reports.push({ ...doc.data(), id: doc.id })
            );

            if (searchTerm) {
              reports = reports.filter(
                (report) =>
                  report.fundName
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase()) ||
                  report.analysisDate
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase())
              );
            }

            reportsList.innerHTML = "";
            if (reports.length === 0) {
              reportsList.innerHTML =
                "<p>Nenhum relatório encontrado com o termo pesquisado.</p>";
              return;
            }

            reportsCount.textContent = reports.length;

            reports.forEach((report) => {
              const statusBadge =
                report.status === "rascunho"
                  ? '<span class="status-draft">[RASCUNHO]</span>'
                  : "";
              const reportElement = document.createElement("div");
              reportElement.className = "report-item";
              reportElement.innerHTML = `
                <div class="report-info">
                    <h3>${report.fundName} ${statusBadge}</h3>
                    <p>Data: ${report.analysisDate} | Atualizado em: ${new Date(
                report.lastUpdated.toDate()
              ).toLocaleString()}</p>
                </div>
                <div class="report-actions">
                    <button class="btn-save report-btn view-btn" data-id="${
                      report.id
                    }"><i class="fas fa-eye"></i> Ver</button>
                    <button class="btn-print report-btn load-btn" data-id="${
                      report.id
                    }"><i class="fas fa-upload"></i> Carregar</button>
                    <button class="btn-reset report-btn delete-btn" data-id="${
                      report.id
                    }"><i class="fas fa-trash"></i> Excluir</button>
                </div>
              `;
              reportsList.appendChild(reportElement);
            });

            reportsList
              .querySelectorAll(".view-btn")
              .forEach((btn) =>
                btn.addEventListener("click", () => viewReport(btn.dataset.id))
              );
            reportsList
              .querySelectorAll(".load-btn")
              .forEach((btn) =>
                btn.addEventListener("click", () => loadReport(btn.dataset.id))
              );
            reportsList
              .querySelectorAll(".delete-btn")
              .forEach((btn) =>
                btn.addEventListener("click", () =>
                  deleteReport(btn.dataset.id)
                )
              );
          } catch (error) {
            console.error("Erro ao buscar relatórios:", error);
            reportsList.innerHTML = `<p class="error-message">Erro ao carregar relatórios: ${error.message}</p>`;
          }
        }

        async function viewReport(id) {
          try {
            const doc = await db.collection("analises").doc(id).get();
            if (!doc.exists) {
              alert("Relatório não encontrado.");
              return;
            }

            const report = doc.data();
            document.getElementById(
              "modal-title"
            ).textContent = `Relatório Completo: ${report.fundName}`;
            const modalBody = document.getElementById("modal-body");

            const createItem = (label, value) => {
              if (
                value === null ||
                value === undefined ||
                value === "" ||
                (Array.isArray(value) && value.length === 0)
              )
                return "";
              const displayValue = Array.isArray(value)
                ? value.join(", ")
                : value;
              return `<div class="grid-item"><strong>${label}</strong><p>${displayValue}</p></div>`;
            };

            const createTextareaItem = (label, value) => {
              if (!value) return "";
              return `<div style="grid-column: 1 / -1;"><h3>${label}</h3><p style="white-space: pre-wrap; word-wrap: break-word;">${value}</p></div>`;
            };

            const friendlyValues = {
              sim: "Sim",
              nao: "Não",
              parcial: "Parcialmente",
              ativa: "Ativa",
              passiva: "Passiva",
              acima: "Acima do IFIX",
              abaixo: "Abaixo do IFIX",
              junto: "Junto ao IFIX",
              alta: "Alta",
              media: "Média",
              baixa: "Baixa",
              superior: "Superior",
              inferior: "Inferior",
              igual: "Igual",
              estavel: "Estabilizada",
              crescente: "Crescente",
              decrescente: "Decrescente",
              baixo: "Baixo",
              medio: "Médio",
              alto: "Alto",
              melhora: "Melhora",
              estabilidade: "Estabilidade",
              piora: "Piora",
              acompanhar: "Acompanhar",
              aumentar: "Aumentar posição",
              reduzir: "Reduzir exposição",
              evitar: "Evitar",
            };

            const vereditoHtml = `<h3>✅ Veredito da Análise</h3><div class="report-grid">${createItem(
              "Recomendação",
              `<strong>${
                friendlyValues[report.recommendation] || "N/A"
              }</strong>`
            )}${createItem(
              "Nível de Risco",
              friendlyValues[report.riskLevel]
            )}${createItem(
              "Classificação do Fundo",
              report.fundClassification
            )}${createItem(
              "Expectativa p/ Resultados",
              friendlyValues[report.expectation]
            )}${createItem(
              "Data da Análise",
              report.analysisDate
            )}</div>${createTextareaItem(
              "Pontos Positivos",
              report.positivePoints
            )}${createTextareaItem(
              "Pontos Negativos",
              report.negativePoints
            )}${createTextareaItem(
              "Principais Riscos Elencados",
              report.mainRisks
            )}${createTextareaItem(
              "Oportunidades Claras",
              report.opportunities
            )}`;
            const indicadoresHtml = `<h3>📊 Painel de Indicadores Chave</h3><div class="report-grid">${createItem(
              "Vacância Financeira",
              report.financialVacancy
            )}${createItem(
              "Vacância Física",
              report.physicalVacancy
            )}${createItem("Inadimplência", report.defaultRate)}${createItem(
              "Liquidez",
              friendlyValues[report.liquidity]
            )}${createItem(
              "Comparação com IFIX",
              friendlyValues[report.ifixComparison]
            )}${createItem("FFO vs DY", report.ffoVsDy)}</div>`;
            const desempenhoHtml = `<h3>📈 Desempenho & Valuation</h3><div class="report-grid">${createItem(
              "Cotação vs Média 12M",
              report.currentVsAvg
            )}${createItem(
              "Rendimento vs Média Histórica",
              report.yieldComparison
            )}${createItem(
              "DY vs Média do Setor",
              report.sectorComparison
            )}</div>${createTextareaItem(
              "Evolução do VPC (últimos 12 meses)",
              report.vpcEvolution
            )}${createTextareaItem(
              "Análise de Desconto/Justificativa",
              report.discount
            )}`;
            let tijoloHtml = "";
            if (
              report.propertyCount ||
              report.activeTenants ||
              report.tenantConcentration
            ) {
              tijoloHtml = `<h3>🧱 Portfólio: Ativos Físicos (Tijolo)</h3><div class="report-grid">${createItem(
                "Segmentos",
                report.segments
              )}${createItem(
                "Quantidade de Imóveis",
                report.propertyCount
              )}${createItem(
                "Inquilinos Ativos",
                report.activeTenants
              )}${createItem(
                "% Contratos Típicos",
                report.typicalContracts
              )}${createItem(
                "% Contratos Atípicos",
                report.atypicalContracts
              )}${createItem(
                "Venc. Médio Contratos",
                report.averageContractTerm
                  ? `${report.averageContractTerm} meses`
                  : null
              )}${createItem(
                "% Carteira no Maior Setor",
                report.largestSector
              )}${createItem(
                "Inquilino em Carência?",
                friendlyValues[report.gracePeriod]
              )}</div>${createTextareaItem(
                "Segmentos dos Inquilinos",
                report.tenantSegments
              )}${createTextareaItem(
                "Concentração por Inquilino",
                report.tenantConcentration
              )}${createTextareaItem(
                "Situação Financeira do Maior Inquilino",
                report.tenantFinancials
              )}`;
            }
            let papelHtml = "";
            if (
              report.creditsCount ||
              report.averageLtv ||
              report.debtorConcentration
            ) {
              papelHtml = `<h3>📄 Portfólio: Ativos Financeiros (Papel)</h3><div class="report-grid">${createItem(
                "Quantidade de Créditos",
                report.creditsCount
              )}${createItem(
                "% Indexado ao CDI",
                report.indexerCdi
              )}${createItem(
                "% Indexado ao IPCA",
                report.indexerIpca
              )}${createItem(
                "Taxa Média CDI+",
                report.creditRateCdi
              )}${createItem(
                "Taxa Média IPCA+",
                report.creditRateIpca
              )}${createItem(
                "Duration da Carteira",
                report.creditDuration ? `${report.creditDuration} anos` : null
              )}${createItem("LTV Médio", report.averageLtv)}${createItem(
                "Créditos sem Garantia?",
                friendlyValues[report.unsecuredCredits]
              )}</div>${createItem(
                "Garantias Praticadas",
                report.warranties
              )}${createTextareaItem(
                "Concentração por Devedor",
                report.debtorConcentration
              )}${createTextareaItem(
                "Situação Financeira do Principal Devedor",
                report.mainDebtorFinancials
              )}`;
            }
            const saudeFinanceiraHtml = `<h3>❤️ Saúde Financeira</h3><div class="report-grid">${createItem(
              "Possui Alavancagem?",
              friendlyValues[report.leverage]
            )}${createItem(
              "Taxa Média da Alavancagem",
              report.leverageRate
            )}${createItem(
              "Sustentabilidade do Saldo",
              report.balanceSustainability
            )}</div>${createTextareaItem(
              "Plano de Amortização da Dívida",
              report.amortizationPlan
            )}${createTextareaItem(
              "O Fundo está Queimando Caixa?",
              report.cashBurn
            )}`;
            const governancaHtml = `<h3>🔎 Governança e Gestão</h3><div class="report-grid">${createItem(
              "Tipo de Gestão",
              friendlyValues[report.managementType]
            )}${createItem(
              "Transparência",
              friendlyValues[report.transparency]
            )}${createItem(
              "Conflitos de Interesse?",
              friendlyValues[report.conflicts]
            )}</div>${createTextareaItem(
              "Sobre o Gestor e seu Histórico",
              report.managerHistory
            )}${createTextareaItem(
              "Comunicados Importantes no Período",
              report.importantNotices
            )}`;

            modalBody.innerHTML = `${vereditoHtml}${indicadoresHtml}${desempenhoHtml}${tijoloHtml}${papelHtml}${saudeFinanceiraHtml}${governancaHtml}`;
            reportModal.style.display = "flex";
          } catch (error) {
            console.error("Erro ao visualizar relatório:", error);
            alert("Erro ao visualizar relatório: " + error.message);
          }
        }

        async function loadReport(id) {
          try {
            const doc = await db.collection("analises").doc(id).get();
            if (!doc.exists) {
              alert("Relatório não encontrado.");
              return;
            }
            const report = doc.data();

            document.getElementById("checklist-form").reset(); 

            // Helper functions to be used only within this function
            const setValue = (elementId, value) => {
                const el = document.getElementById(elementId);
                if (el && value !== undefined && value !== null) {
                    el.value = value;
                }
            };
            
            const setRadio = (name, value) => {
                if (value) {
                    const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                }
            };

            const setCheckboxes = (name, ids) => {
                if (ids && Array.isArray(ids)) {
                    document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
                        cb.checked = false;
                    });
                    ids.forEach(checkboxId => {
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            };

            // --- MOSTRA O FORMULÁRIO E A SEÇÃO CORRETA ---
            analysisChoiceContainer.style.display = 'none';
            analysisFormContainer.style.display = 'block';

            if (report.creditsCount || report.averageLtv) { // Identifica como FII de Papel
                paperSection.style.display = 'block';
                tijoloSection.style.display = 'none';
            } else if (report.propertyCount || report.activeTenants) { // Identifica como FII de Tijolo
                paperSection.style.display = 'none';
                tijoloSection.style.display = 'block';
            }


            // --- POPULA TODOS OS CAMPOS EXPLICITAMENTE ---

            // Basic Info
            setValue("fund-name", report.fundName);
            setValue("analysis-date", report.analysisDate);
            setValue("analyst-name", report.analystName);

            // Paper Analysis
            setValue("allocation-cri-cra", report.allocationCriCra);
            setValue("allocation-fiis-paper", report.allocationFiisPaper);
            setValue("allocation-cash-paper", report.allocationCashPaper);
            setValue("credits-count", report.creditsCount);
            setValue("indexer-cdi", report.indexerCdi);
            setValue("indexer-ipca", report.indexerIpca);
            setValue("credit-rate-cdi", report.creditRateCdi);
            setValue("credit-rate-ipca", report.creditRateIpca);
            setValue("credit-duration", report.creditDuration);
            setCheckboxes("warranty", report.warranties);
            setRadio("unsecured-credits", report.unsecuredCredits);
            setValue("average-ltv", report.averageLtv);
            setValue("debtor-segments", report.debtorSegments);
            setValue("debtor-concentration", report.debtorConcentration);
            setValue("main-debtor-financials", report.mainDebtorFinancials);
            
            // Tijolo Analysis
            setCheckboxes("segment", report.segments);
            if (report.segments && report.segments.includes("other-segment")) {
                const otherSegmentEl = document.getElementById("other-segment-text");
                otherSegmentEl.value = report.otherSegment || "";
                otherSegmentEl.style.display = "block";
            }
            setValue("property-count", report.propertyCount);
            setValue("allocation-properties", report.allocationProperties);
            setValue("allocation-fiis", report.allocationFiis);
            setValue("allocation-cash", report.allocationCash);
            setValue("typical-contracts", report.typicalContracts);
            setValue("atypical-contracts", report.atypicalContracts);
            setValue("average-contract-term", report.averageContractTerm);
            setValue("expiring-contracts", report.expiringContracts);
            setValue("active-tenants", report.activeTenants);
            setValue("tenant-segments", report.tenantSegments);
            setValue("largest-sector", report.largestSector);
            setValue("tenant-concentration", report.tenantConcentration);
            setValue("tenant-financials", report.tenantFinancials);
            setRadio("grace-period", report.gracePeriod);

            // Fund Structure
            setValue("strategy", report.strategy);
            setRadio("management-type", report.managementType);
            setRadio("ifix-comparison", report.ifixComparison);
            setValue("admin-fee", report.adminFee);
            setValue("performance-fee", report.performanceFee);
            setValue("ffo-vs-dy", report.ffoVsDy);
            setValue("extraordinary-revenue", report.extraordinaryRevenue);

            // Governance
            setValue("manager-history", report.managerHistory);
            setRadio("manager-change", report.managerChange);
            setValue("manager-change-details", report.managerChangeDetails);
            setRadio("conflicts", report.conflicts);
            setValue("conflicts-details", report.conflictsDetails);
            setRadio("transparency", report.transparency);
            
            // Vacancy & Revenue
            setValue("financial-vacancy", report.financialVacancy);
            setValue("physical-vacancy", report.physicalVacancy);
            setValue("default-rate", report.defaultRate);
            setRadio("result-comparison", report.resultComparison);
            setValue("result-reason", report.resultReason);

            // Comparative Performance
            setValue("vpc-evolution", report.vpcEvolution);
            setValue("current-vs-avg", report.currentVsAvg);
            setValue("yield-comparison", report.yieldComparison);
            setValue("sector-comparison", report.sectorComparison);
            setCheckboxes("fund-classification", report.fundClassification);

            // Leverage
            setRadio("leverage", report.leverage);
            setValue("leverage-rate", report.leverageRate);
            setValue("amortization-plan", report.amortizationPlan);
            
            // Liquidity
            setRadio("liquidity", report.liquidity);
            setValue("important-notices", report.importantNotices);
            
            // Risk & Opportunity
            setRadio("risk-level", report.riskLevel);
            setValue("main-risks", report.mainRisks);
            setValue("opportunities", report.opportunities);
            setRadio("anchor", report.anchor);

            // Conclusion
            setValue("positive-points", report.positivePoints);
            setValue("negative-points", report.negativePoints);
            setValue("cash-burn", report.cashBurn);
            setValue("balance-sustainability", report.balanceSustainability);
            setValue("discount", report.discount);
            setRadio("expectation", report.expectation);
            setRadio("recommendation", report.recommendation);

            // Observations
            if (report.observations && Array.isArray(report.observations)) {
              const textareas = document.querySelectorAll(".observations");
              textareas.forEach((textarea, index) => {
                if (report.observations[index]) {
                  textarea.value = report.observations[index];
                }
              });
            }

            calculateFormProgress();
            document.querySelector('.tab[data-tab="form"]').click();

            alert(
              `Relatório de ${report.fundName} carregado. Você pode editá-lo e, ao salvar, o sistema perguntará se deseja sobrescrever o original.`
            );
          } catch (error) {
            console.error("Erro ao carregar relatório:", error);
            alert("Erro ao carregar relatório: " + error.message);
          }
        }

        async function deleteReport(id) {
          if (!confirm("Tem certeza que deseja excluir este relatório?"))
            return;
          try {
            await db.collection("analises").doc(id).delete();
            alert("Relatório excluído com sucesso.");
            updateReportsList();
          } catch (error) {
            console.error("Erro ao excluir relatório:", error);
            alert("Erro ao excluir relatório: " + error.message);
          }
        }

        function calculateFormProgress() {
            const form = document.getElementById("checklist-form");
            // Se o formulário não estiver visível, o progresso é 0
            if (form.offsetParent === null) {
                progressFill.style.width = '0%';
                progressPercentage.textContent = '0%';
                return;
            }
            
            const allInputs = Array.from(form.querySelectorAll("input, textarea, select"));

            let totalPoints = 0;
            let scoredPoints = 0;

            const countedNames = new Set(); // Para evitar contar grupos de radio/checkbox múltiplas vezes

            allInputs.forEach(el => {
                // Ignora elementos que não devem contar para o progresso
                if (el.offsetParent === null || el.type === 'hidden' || el.type === 'reset' || el.type === 'button') {
                    return;
                }

                if (el.type === 'radio' || el.type === 'checkbox') {
                    // Se este grupo ainda não foi contado
                    if (!countedNames.has(el.name)) {
                        countedNames.add(el.name);
                        totalPoints++;
                        // Verifica se alguma opção no grupo está marcada
                        if (form.querySelector(`[name="${el.name}"]:checked`)) {
                            scoredPoints++;
                        }
                    }
                } else { // Para text, textarea, number, etc.
                    totalPoints++;
                    // Conta como preenchido se tiver um valor
                    if (el.value && el.value.trim() !== "") {
                        scoredPoints++;
                    }
                }
            });

            const finalProgress = totalPoints > 0 ? Math.round((scoredPoints / totalPoints) * 100) : 0;
            progressFill.style.width = `${finalProgress}%`;
            progressPercentage.textContent = `${finalProgress}%`;
        }

        function getSelectedCheckboxes(name) {
          return Array.from(
            document.querySelectorAll(`input[name="${name}"]:checked`)
          ).map((cb) => cb.id);
        }

        function getSelectedRadio(name) {
          const radio = document.querySelector(`input[name="${name}"]:checked`);
          return radio ? radio.value : null;
        }
      });
    </script>
  </body>
</html>