<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checklist RI - FIIs (mensal)</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa7b2; --accent:#60a5fa; --glass: rgba(255,255,255,0.03);
    --success:#10b981; --danger:#ef4444; --card-border: rgba(255,255,255,0.04);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#071027 0%, #071a2a 100%); color:#e6eef3;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1100px;margin:28px auto;padding:20px;}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  .topbar{display:flex;gap:8px;margin-left:auto;align-items:center}
  select,input[type="text"],button{
    background:var(--glass);border:1px solid var(--card-border);color:inherit;padding:8px 10px;border-radius:8px;font-size:14px;
  }
  button{cursor:pointer}
  .layout{display:grid;grid-template-columns:260px 1fr;gap:16px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--card-border); padding:12px;border-radius:12px}
  .months{display:flex;flex-direction:column;gap:8px}
  .month-btn{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:transparent;border:1px dashed var(--card-border);font-size:14px}
  .month-btn.active{background:linear-gradient(90deg, rgba(96,165,250,0.12), rgba(96,165,250,0.04));border:1px solid rgba(96,165,250,0.18)}
  .controls{display:flex;gap:8px;align-items:center}
  .search{margin:8px 0}
  .content{max-height:72vh;overflow:auto;padding:12px}
  section{margin-bottom:18px}
  section h2{margin:0 0 8px 0;font-size:15px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .item{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;border:1px solid transparent}
  label{display:flex;align-items:center;gap:8px}
  input[type="checkbox"]{width:18px;height:18px}
  .note{width:100%;min-height:36px;padding:8px;border-radius:8px;background:#071827;border:1px solid var(--card-border);color:var(--muted);resize:vertical}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .small{font-size:13px;color:var(--muted)}
  .btn-danger{background:transparent;border:1px solid var(--danger);color:var(--danger);padding:6px 8px;border-radius:8px}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#3b82f6);border:0;color:#021127;padding:8px 12px;border-radius:8px}
  .controls .icon{opacity:0.9}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid var(--card-border)}
  /* responsive */
  @media(max-width:880px){
    .layout{grid-template-columns:1fr; }
    .months{flex-direction:row;overflow:auto}
    .months .month-btn{min-width:200px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>üìã Checklist RI ‚Äî Fundos Imobili√°rios</h1>
      <div class="sub">Mantenha um hist√≥rico mensal ‚Äî salva localmente no navegador</div>
    </div>

    <div class="topbar">
      <div class="controls">
        <select id="monthSelect" title="Escolha m√™s/ano"></select>
        <input id="newMonthName" type="text" placeholder="MM/YYYY (Ex: 09/2025)" style="width:120px">
        <button id="addMonthBtn" title="Adicionar m√™s">‚ûï</button>
        <button id="saveBtn" class="btn-primary" title="Salvar agora">Salvar</button>
      </div>
      <div style="width:10px"></div>
      <button id="exportBtn">Exportar JSON</button>
      <button id="importBtn">Importar JSON</button>
      <input id="importFile" type="file" accept=".json" style="display:none">
      <button id="printBtn">Imprimir</button>
    </div>
  </header>

  <div class="layout">
    <aside class="panel">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <strong>Meses salvos</strong>
        <span class="tag" id="countTag">0</span>
      </div>
      <div class="months" id="monthsList" aria-live="polite"></div>
      <div style="margin-top:12px">
        <div class="small">Busca no checklist:</div>
        <input id="searchInput" type="text" placeholder="Pesquisar termo..." style="width:100%;margin-top:6px">
      </div>
      <hr style="margin:12px 0;border-color:var(--card-border)">
      <div class="small">Exportar / Importar salva todo o banco local (√∫til para backup).</div>
      <div style="margin-top:10px" class="small muted">OBS: dados ficam no navegador; limpar cache remove tudo.</div>
    </aside>

    <main class="panel">
      <div class="content" id="contentArea">
        <!-- CHECKLIST START -->
        <section id="s-estrutura">
          <h2>üè¶ Estrutura do Fundo</h2>
          <div class="item"><label><input type="checkbox" data-key="estrutura.estrategia_present" /> <div><strong>Qual a estrat√©gia/objetivo do fundo?</strong><div class="muted">Ex: renda, ganho de capital...</div></div></label></div>
          <div class="item"><label><input type="checkbox" data-key="estrutura.segmento_present" /> <div><strong>Segmento principal do fundo?</strong><div class="muted">Ex: Log√≠stica, Lajes, Shoppings ‚Äî H√≠brido n√£o √© segmento</div></div></label></div>
          <div class="item"><label><input type="checkbox" data-key="estrutura.gestao_ativa" /> <div><strong>Tipo de gest√£o - Ativa</strong></div></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="estrutura.gestao_passiva" /> <div><strong>Tipo de gest√£o - Passiva</strong></div></label>
          </div>
          <div class="item"><label><input type="checkbox" data-key="estrutura.ifix_acima" /> <div><strong>Compara√ß√£o com IFIX ‚Äî Acima</strong></div></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="estrutura.ifix_abaixo" /> <div><strong>Abaixo</strong></div></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="estrutura.ifix_junto" /> <div><strong>Junto</strong></div></label>
          </div>
          <div style="margin-top:8px"><textarea class="note" data-key="estrutura.obs" placeholder="Observa√ß√µes sobre estrutura (escreva texto livre)"></textarea></div>
        </section>

        <section id="s-custos">
          <h2>üí∞ Custos do Fundo</h2>
          <div class="grid-2">
            <div class="item"><div style="width:100%"><label><input type="checkbox" data-key="custos.adm_present" /> <strong>Taxa de administra√ß√£o (%)</strong></label><div style="margin-top:6px"><input type="text" data-key="custos.adm_val" placeholder="Ex: 0.9% ou R$ ..." style="width:100%"></div></div></div>
            <div class="item"><div style="width:100%"><label><input type="checkbox" data-key="custos.perf_present" /> <strong>Taxa de performance (%)</strong></label><div style="margin-top:6px"><input type="text" data-key="custos.perf_val" placeholder="Benchmark e %"></div></div></div>
            <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="custos.outras" /> <strong>Outras taxas relevantes</strong></label>
              <div style="margin-top:6px"><textarea class="note" data-key="custos.outras_obs" placeholder="detalhe outras taxas"></textarea></div>
            </div>
          </div>
        </section>

        <section id="s-distrib">
          <h2>üí∏ Distribui√ß√£o de Rendimentos</h2>
          <div class="item">
            <label><input type="checkbox" data-key="dist.padrao_queda" /> <strong>Padr√£o: Queda</strong></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="dist.padrao_const" /> <strong>Constante</strong></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="dist.padrao_cres" /> <strong>Crescente</strong></label>
          </div>
          <div class="item"><label><input type="checkbox" data-key="dist.aumenta_aa" /> <strong>Distribui√ß√£o aumentando ano a ano?</strong></label></div>
          <div class="item"><label><input type="checkbox" data-key="dist.resultado_maior" /> <strong>Resultado por cota maior que a distribui√ß√£o</strong></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="dist.resultado_menor" /> <strong>Resultado por cota menor</strong></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="dist.resultado_igual" /> <strong>Igual</strong></label>
          </div>
          <div style="margin-top:8px"><textarea class="note" data-key="dist.saldo_acum" placeholder="Saldo acumulado por cota (R$)"></textarea></div>
          <div style="margin-top:8px"><textarea class="note" data-key="dist.ffo_vs_dy" placeholder="Coment√°rio: FFO vs DY e se h√° receitas extraordin√°rias"></textarea></div>
        </section>

        <section id="s-portfolio">
          <h2>üèòÔ∏è Portf√≥lio e Contratos</h2>
          <div class="grid-2">
            <div class="item"><label><input type="checkbox" data-key="port.qtd_imoveis" /> <strong>Quantidade de im√≥veis</strong></label><input type="text" data-key="port.qtd_imoveis_val" placeholder="Ex: 12"></div>
            <div class="item"><label><input type="checkbox" data-key="port.alocacao" /> <strong>Aloca√ß√£o (%) Im√≥veis / FIIs / Caixa</strong></label><input type="text" data-key="port.alocacao_val" placeholder="Ex: 70/15/15"></div>
            <div class="item"><label><input type="checkbox" data-key="port.pct_tipicos" /> <strong>% contratos t√≠picos</strong></label><input type="text" data-key="port.pct_tipicos_val" placeholder="Ex: 80%"></div>
            <div class="item"><label><input type="checkbox" data-key="port.pct_atipicos" /> <strong>% contratos at√≠picos</strong></label><input type="text" data-key="port.pct_atipicos_val" placeholder="Ex: 20%"></div>
            <div class="item"><label><input type="checkbox" data-key="port.wault" /> <strong>WAULT / tempo m√©dio vencimento</strong></label><input type="text" data-key="port.wault_val" placeholder="Ex: 3,2 anos"></div>
            <div class="item"><label><input type="checkbox" data-key="port.prox_venc" /> <strong>Contratos pr√≥ximos do vencimento (% receita)</strong></label><input type="text" data-key="port.prox_venc_val" placeholder="Ex: 12%"></div>
            <div class="item"><label><input type="checkbox" data-key="port.qtd_inquilinos" /> <strong>Quantidade de inquilinos</strong></label><input type="text" data-key="port.qtd_inquilinos_val" placeholder="Ex: 8"></div>
            <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="port.segmentos_inquilinos" /> <strong>Segmentos dos inquilinos</strong></label><textarea class="note" data-key="port.segmentos_inquilinos_val" placeholder="Descrever setores e %"></textarea></div>

            <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="port.concentracao" /> <strong>Concentra√ß√£o em 1 inquilino? qual % e situa√ß√£o financeira</strong></label><textarea class="note" data-key="port.concentracao_val" placeholder="Nome, % e an√°lise"></textarea></div>
            <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="port.carencia" /> <strong>Inquilino em per√≠odo de car√™ncia?</strong></label><textarea class="note" data-key="port.carencia_val" placeholder="Detalhes"></textarea></div>
          </div>
        </section>

        <section id="s-op">
          <h2>üìâ Indicadores Operacionais</h2>
          <div class="grid-2">
            <div class="item"><label><input type="checkbox" data-key="op.vacancia_fisica" /> <strong>Vac√¢ncia f√≠sica (%)</strong></label><input type="text" data-key="op.vacancia_fisica_val" placeholder="Ex: 5%"></div>
            <div class="item"><label><input type="checkbox" data-key="op.vacancia_financeira" /> <strong>Vac√¢ncia financeira (%)</strong></label><input type="text" data-key="op.vacancia_financeira_val" placeholder="Ex: 6%"></div>
            <div class="item"><label><input type="checkbox" data-key="op.inadimplencia" /> <strong>Inadimpl√™ncia (%)</strong></label><input type="text" data-key="op.inadimplencia_val" placeholder="Ex: 1.2%"></div>
            <div class="item"><label><input type="checkbox" data-key="op.alavancagem" /> <strong>Alavancagem / D√≠vida</strong></label><input type="text" data-key="op.alavancagem_val" placeholder="Ex: D√≠vida = 20% PL"></div>
            <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="op.juros_media" /> <strong>Taxa m√©dia da alavancagem</strong></label><input type="text" data-key="op.juros_media_val" placeholder="Ex: CDI+2%"></div>
            <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="op.plano_amort" /> <strong>Plano de amortiza√ß√£o</strong></label><textarea class="note" data-key="op.plano_amort_val" placeholder="Resumo do plano"></textarea></div>
          </div>
        </section>

        <section id="s-resultados">
          <h2>üìë Resultados</h2>
          <div class="item"><label><input type="checkbox" data-key="res.mais_menor" /> <strong>Resultado superior/ inferior ao m√™s anterior?</strong></label></div>
          <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="res.motivo_variacao" /> <strong>Motivo da varia√ß√£o</strong></label><textarea class="note" data-key="res.motivo_variacao_val" placeholder="Descrever motivos (aquisi√ß√µes, vac√¢ncia...)"></textarea></div>
          <div class="item"><label><input type="checkbox" data-key="res.dy_vs_hist" /> <strong>DY atual x hist√≥rico (12 meses)</strong></label></div>
          <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="res.tendencia" /> <strong>Tend√™ncia dos √∫ltimos 12 meses</strong></label><input type="text" data-key="res.tendencia_val" placeholder="Melhora / Estabilidade / Piora"></div>
        </section>

        <section id="s-comunicados">
          <h2>üîî Comunicados Importantes</h2>
          <div class="item"><label><input type="checkbox" data-key="com.acquis" /> <strong>Novas aquisi√ß√µes?</strong></label></div>
          <div class="item"><label><input type="checkbox" data-key="com.vendas" /> <strong>Vendas relevantes?</strong></label></div>
          <div class="item"><label><input type="checkbox" data-key="com.probs_inq" /> <strong>Problemas com inquilinos?</strong></label></div>
          <div style="margin-top:8px"><textarea class="note" data-key="com.obs" placeholder="Resumo de comunicados / fatos relevantes"></textarea></div>
        </section>

        <section id="s-liquidez">
          <h2>üìä Liquidez em Bolsa</h2>
          <div class="item"><label><input type="checkbox" data-key="liq.volume" /> <strong>Volume m√©dio di√°rio (R$)</strong></label><input type="text" data-key="liq.volume_val" placeholder="Ex: R$ 120k"></div>
          <div class="item"><label><input type="checkbox" data-key="liq.trend" /> <strong>Liquidez: Est√°vel / Crescente / Decrescente</strong></label><input type="text" data-key="liq.trend_val" placeholder="Ex: Est√°vel"></div>
          <div class="item"><label><input type="checkbox" data-key="liq.preco_vp" /> <strong>Pre√ßo vs VP (%)</strong></label><input type="text" data-key="liq.preco_vp_val" placeholder="Ex: -8%"></div>
        </section>

        <section id="s-risco">
          <h2>‚öñÔ∏è Riscos e Oportunidades</h2>
          <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="risk.principais" /> <strong>Principais riscos (listar)</strong></label><textarea class="note" data-key="risk.principais_val" placeholder="Liste riscos"></textarea></div>
          <div class="item"><label><input type="checkbox" data-key="risk.grau_baixo" /> <strong>Baixo</strong></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="risk.grau_medio" /> <strong>M√©dio</strong></label>
            <label style="margin-left:8px"><input type="checkbox" data-key="risk.grau_alto" /> <strong>Alto</strong></label>
          </div>
          <div class="item" style="grid-column:1/3"><label><input type="checkbox" data-key="risk.oportunidades" /> <strong>Oportunidades futuras</strong></label><textarea class="note" data-key="risk.oportunidades_val" placeholder="Descrever oportunidades"></textarea></div>
        </section>

        <section id="s-aten√ß√£o">
          <h2>üëÄ Pontos de Aten√ß√£o</h2>
          <div class="item"><label><input type="checkbox" data-key="attention.vacancia" /> <strong>Vac√¢ncia crescente?</strong></label></div>
          <div class="item"><label><input type="checkbox" data-key="attention.concentracao" /> <strong>Concentra√ß√£o excessiva?</strong></label></div>
          <div class="item"><label><input type="checkbox" data-key="attention.receitas_extra" /> <strong>Depend√™ncia de receitas extraordin√°rias?</strong></label></div>
          <div style="margin-top:8px"><textarea class="note" data-key="attention.obs" placeholder="Observa√ß√µes e monitoramento"></textarea></div>
        </section>

        <section id="s-conclusao">
          <h2>‚úÖ Conclus√£o</h2>
          <div style="display:grid;gap:8px">
            <textarea class="note" data-key="conclusao.positivos" placeholder="Pontos positivos"></textarea>
            <textarea class="note" data-key="conclusao.negativos" placeholder="Pontos negativos"></textarea>
            <textarea class="note" data-key="conclusao.quemando_caixa" placeholder="Fundo est√° queimando caixa? Por qu√™?"></textarea>
            <textarea class="note" data-key="conclusao.saldo_sustenta" placeholder="O saldo acumulado sustentar√° por quanto tempo?"></textarea>
            <textarea class="note" data-key="conclusao.desconto_just" placeholder="Fundo descontado? O desconto √© justific√°vel?"></textarea>
            <div class="row">
              <div style="flex:1"><label><input type="checkbox" data-key="conclusao.expect_melhora" /> Melhora</label></div>
              <div style="flex:1"><label><input type="checkbox" data-key="conclusao.expect_estab" /> Estabilidade</label></div>
              <div style="flex:1"><label><input type="checkbox" data-key="conclusao.expect_piora" /> Piora</label></div>
            </div>
            <div style="display:flex;gap:8px">
              <label style="flex:1"><input type="checkbox" data-key="conclusao.rec_acompanhar" /> Acompanhar</label>
              <label style="flex:1"><input type="checkbox" data-key="conclusao.rec_aumentar" /> Aumentar posi√ß√£o</label>
              <label style="flex:1"><input type="checkbox" data-key="conclusao.rec_reduzir" /> Reduzir exposi√ß√£o</label>
              <label style="flex:1"><input type="checkbox" data-key="conclusao.rec_evitar" /> Evitar</label>
            </div>
          </div>
        </section>

        <!-- CHECKLIST END -->
      </div>

      <footer>
        <div class="small">√öltima edi√ß√£o: <span id="lastSaved">‚Äî</span></div>
        <div><button id="clearBtn" class="btn-danger">Limpar m√™s</button></div>
      </footer>
    </main>
  </div>
</div>

<script>
/* Simple monthly checklist app ‚Äî stores per-month in localStorage under key 'fii_checklist_v1' */
const STORAGE_KEY = 'fii_checklist_v1';

const defaultStructure = () => {
  // Collect all controls by data-key and store default empty values
  const nodes = document.querySelectorAll('[data-key]');
  const obj = {};
  nodes.forEach(n=>{
    const k = n.getAttribute('data-key');
    if(!k) return;
    if(n.type === 'checkbox'){
      obj[k] = false;
    } else if(n.tagName === 'TEXTAREA' || n.tagName === 'INPUT'){
      obj[k] = '';
    } else {
      obj[k] = '';
    }
  });
  return obj;
};

function loadDB(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : { months: {}, order: [] };
  }catch(e){ return { months: {}, order: [] }; }
}

function saveDB(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

function populateMonthSelect(){
  const sel = document.getElementById('monthSelect');
  sel.innerHTML = '';
  const db = loadDB();
  db.order.forEach(m=>{
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    sel.appendChild(opt);
  });
  if(sel.options.length) sel.value = sel.options[sel.options.length-1].value;
}

function renderMonthsList(){
  const list = document.getElementById('monthsList');
  list.innerHTML = '';
  const db = loadDB();
  db.order.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'month-btn' + (m === getCurrentMonthKey() ? ' active' : '');
    div.textContent = m;
    div.onclick = ()=>{ setCurrentMonth(m); };
    const del = document.createElement('button');
    del.textContent = 'üóëÔ∏è';
    del.style.marginLeft='8px'; del.title='Remover m√™s';
    del.onclick = (ev)=>{ ev.stopPropagation(); if(confirm('Remover m√™s "'+m+'"?')){ deleteMonth(m); } };
    div.appendChild(del);
    list.appendChild(div);
  });
  document.getElementById('countTag').textContent = db.order.length;
}

function getCurrentMonthKey(){
  const sel = document.getElementById('monthSelect');
  return sel.value || null;
}

function setCurrentMonth(m){
  const sel = document.getElementById('monthSelect');
  sel.value = m;
  renderMonthsList();
  loadMonthToUI(m);
}

function addMonth(m){
  if(!m) { alert('Informe M√äS/ANO no formato MM/YYYY'); return; }
  const db = loadDB();
  if(db.order.includes(m)){ alert('M√™s j√° existe'); return; }
  db.order.push(m);
  db.months[m] = defaultStructure();
  saveDB(db);
  populateMonthSelect();
  renderMonthsList();
  setCurrentMonth(m);
}

function deleteMonth(m){
  const db = loadDB();
  if(!db.order.includes(m)) return;
  delete db.months[m];
  db.order = db.order.filter(x=>x!==m);
  saveDB(db);
  populateMonthSelect();
  renderMonthsList();
  const sel = document.getElementById('monthSelect');
  if(sel.options.length) setCurrentMonth(sel.options[sel.options.length-1].value);
  else clearUI();
}

function clearUI(){
  const nodes = document.querySelectorAll('[data-key]');
  nodes.forEach(n=>{
    if(n.type==='checkbox') n.checked = false;
    else n.value = '';
  });
  document.getElementById('lastSaved').textContent = '‚Äî';
}

function loadMonthToUI(m){
  const db = loadDB();
  const data = db.months[m] || defaultStructure();
  const nodes = document.querySelectorAll('[data-key]');
  nodes.forEach(n=>{
    const k = n.getAttribute('data-key');
    if(!(k in data)) {
      // keep default
      if(n.type==='checkbox') n.checked = false; else n.value='';
      return;
    }
    if(n.type==='checkbox') n.checked = !!data[k];
    else n.value = data[k] || '';
  });
  const last = localStorage.getItem(STORAGE_KEY + '::lastSaved::' + m);
  document.getElementById('lastSaved').textContent = last ? new Date(last).toLocaleString() : '‚Äî';
}

function saveCurrentMonth(){
  const m = getCurrentMonthKey();
  if(!m) { alert('Escolha ou adicione um m√™s primeiro.'); return; }
  const db = loadDB();
  const nodes = document.querySelectorAll('[data-key]');
  db.months[m] = db.months[m] || {};
  nodes.forEach(n=>{
    const k = n.getAttribute('data-key');
    if(!k) return;
    if(n.type==='checkbox') db.months[m][k] = !!n.checked;
    else db.months[m][k] = n.value || '';
  });
  saveDB(db);
  localStorage.setItem(STORAGE_KEY + '::lastSaved::' + m, new Date().toISOString());
  document.getElementById('lastSaved').textContent = new Date().toLocaleString();
  renderMonthsList();
}

function exportJSON(){
  const db = loadDB();
  const blob = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'fii_checklist_backup.json'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result);
      if(!parsed || typeof parsed !== 'object') throw 'Arquivo inv√°lido';
      localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
      populateMonthSelect(); renderMonthsList();
      if(parsed.order && parsed.order.length) setCurrentMonth(parsed.order[parsed.order.length-1]);
      alert('Importa√ß√£o conclu√≠da.');
    }catch(err){
      alert('Erro ao importar: ' + err);
    }
  };
  reader.readAsText(file);
}

function bindUI(){
  document.getElementById('addMonthBtn').onclick = ()=>{
    const nm = document.getElementById('newMonthName').value.trim();
    addMonth(nm);
    document.getElementById('newMonthName').value = '';
  };
  document.getElementById('saveBtn').onclick = saveCurrentMonth;
  document.getElementById('exportBtn').onclick = exportJSON;
  document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
  document.getElementById('importFile').onchange = e=>{ if(e.target.files[0]) importJSONFile(e.target.files[0]); e.target.value = ''; };
  document.getElementById('printBtn').onclick = ()=> window.print();
  document.getElementById('clearBtn').onclick = ()=>{
    const m = getCurrentMonthKey();
    if(!m){ alert('Escolha um m√™s'); return; }
    if(confirm('Limpar dados do m√™s ' + m + ' ?')){ const db=loadDB(); db.months[m]=defaultStructure(); saveDB(db); loadMonthToUI(m); }
  };
  document.getElementById('monthSelect').onchange = (e)=>{ loadMonthToUI(e.target.value); renderMonthsList(); };
  document.getElementById('searchInput').oninput = (e)=> searchInContent(e.target.value);
  // save on change
  document.querySelectorAll('[data-key]').forEach(n=>{
    if(n.type==='checkbox'){
      n.addEventListener('change', ()=> { /* auto-save deferred? keep manual to avoid excessive writes */ });
    } else {
      n.addEventListener('input', ()=>{ /* no-op */ });
    }
  });
  // keyboard shortcut Ctrl+S to save
  window.addEventListener('keydown', (ev)=>{ if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='s'){ ev.preventDefault(); saveCurrentMonth(); } });
}

function searchInContent(term){
  const container = document.getElementById('contentArea');
  const q = term.trim().toLowerCase();
  if(!q){ // clear
    container.querySelectorAll('section').forEach(s=> s.style.display='block');
    container.querySelectorAll('.item').forEach(i=> i.style.display='flex');
    return;
  }
  container.querySelectorAll('section').forEach(section=>{
    let any=false;
    section.querySelectorAll('.item, textarea, input[type="text"]').forEach(node=>{
      const text = (node.innerText || node.value || node.textContent || '').toLowerCase();
      if(text.includes(q)) { any=true; node.style.display = node.classList && node.classList.contains('item') ? 'flex' : 'block'; }
      else node.style.display = (node.classList && node.classList.contains('item')) ? 'none' : node.style.display;
    });
    section.style.display = any ? 'block' : 'none';
  });
}

// initialize
(function init(){
  bindUI();
  populateMonthSelect();
  const db = loadDB();
  if(!db.order.length){
    // create current month by default
    const now = new Date();
    const mm = String(now.getMonth()+1).padStart(2,'0') + '/' + now.getFullYear();
    addMonth(mm);
  } else {
    populateMonthSelect();
    setCurrentMonth(document.getElementById('monthSelect').value);
  }
})();
</script>
</body>
</html>
